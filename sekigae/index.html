<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å®¤ã®å¸­æ›¿ãˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }

        /* æ•™å“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .teacher-desk {
            background: linear-gradient(135deg, #fde047 0%, #facc15 100%);
            padding: 0.75rem 3rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-align: center;
            font-weight: 700;
            color: #854d0e;
            border-bottom: 4px solid #ca8a04;
        }

        /* å¸­ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .seat {
            width: 4.5rem;
            height: 4.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            padding: 0.25rem;
            position: relative;
        }

        .seat:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .seat:active {
            transform: scale(0.95);
        }

        /* å¸­ã®çŠ¶æ…‹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        .seat.empty {
            background-color: #f9fafb;
            border: 2px dashed #d1d5db;
        }

        .seat.boy {
            background-color: #eff6ff;
            border: 2px solid #3b82f6;
        }

        .seat.girl {
            background-color: #fdf2f8;
            border: 2px solid #ec4899;
        }

        .seat.front {
            background-color: #ecfdf5;
            border: 2px solid #10b981;
        }

        .seat.none {
            background-color: #e5e7eb;
            border: 2px solid #9ca3af;
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .seat.drag-over {
            border: 2px solid #4f46e5 !important;
            background-color: #e0e7ff !important;
            transform: scale(1.05);
        }

        .seat.dragging {
            opacity: 0.4;
        }

        /* å¸­å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .seat-number {
            font-size: 0.65rem;
            color: #9ca3af;
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
        }

        .seat-name {
            font-size: 0.85rem;
            font-weight: 700;
            text-align: center;
            word-break: break-word;
            line-height: 1.2;
            width: 100%;
        }

        .seat.boy .seat-name {
            color: #1e40af;
        }

        .seat.girl .seat-name {
            color: #be185d;
        }

        .seat.front .seat-name {
            color: #047857;
        }

        .seat.boy .seat-number {
            color: #93c5fd;
        }

        .seat.girl .seat-number {
            color: #fbcfe8;
        }

        .seat.front .seat-number {
            color: #6ee7b7;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 tracking-tight">æ•™å®¤ã®å¸­æ›¿ãˆãƒ„ãƒ¼ãƒ«</h1>
            <p class="text-gray-600 mt-2">æ•™å®¤ã®ã‚µã‚¤ã‚ºã‚„å¸­ã®ç¨®é¡ã‚’è¨­å®šã—ã€ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§èª¿æ•´ã§ãã¾ã™ã€‚</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- å·¦å´: åº§å¸­é…ç½® (7ã‚«ãƒ©ãƒ å¹…) -->
            <div class="lg:col-span-7 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">1. åº§å¸­ã®é…ç½®</h2>

                    <!-- ã‚°ãƒªãƒƒãƒ‰è¨­å®š -->
                    <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border border-gray-200">
                        <div class="flex items-center">
                            <label class="text-sm text-gray-600 mr-1">æ¨ª(åˆ—):</label>
                            <input type="number" id="grid-cols" value="6" min="1" max="12"
                                class="w-14 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex items-center">
                            <label class="text-sm text-gray-600 mr-1">ç¸¦(è¡Œ):</label>
                            <input type="number" id="grid-rows" value="6" min="1" max="12"
                                class="w-14 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="apply-grid"
                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-1 px-3 rounded transition-colors">
                            å¤‰æ›´
                        </button>
                    </div>
                </div>

                <div class="text-sm text-gray-500 mb-4 text-center">
                    ğŸ’¡ å¸­ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¨®é¡ã‚’å¤‰æ›´ / å‰²ã‚Šå½“ã¦å¾Œã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§å¸­ã‚’å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™
                </div>

                <!-- æ•™å“ -->
                <div class="flex justify-center mb-8">
                    <div class="teacher-desk">æ•™å“</div>
                </div>

                <!-- æ•™å®¤ã®ã‚°ãƒªãƒƒãƒ‰ -->
                <div class="flex-grow flex justify-center items-center overflow-x-auto pb-4">
                    <div id="classroom" class="grid gap-2 sm:gap-3">
                        <!-- åº§å¸­ã¯JavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <!-- å‡¡ä¾‹ -->
                <div class="flex flex-wrap justify-center gap-4 mt-8 p-4 bg-gray-50 rounded-xl">
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#f9fafb] border-2 border-dashed border-[#d1d5db] rounded"></div>
                        <span class="ml-1 text-sm font-medium text-gray-700">é€šå¸¸ç©ºå¸­</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#eff6ff] border-2 border-[#3b82f6] rounded"></div>
                        <span class="ml-1 text-sm font-medium text-gray-700">ç”·å­å¸­</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#fdf2f8] border-2 border-[#ec4899] rounded"></div>
                        <span class="ml-1 text-sm font-medium text-gray-700">å¥³å­å¸­</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#ecfdf5] border-2 border-[#10b981] rounded"></div>
                        <span class="ml-1 text-sm font-medium text-gray-700">ç›®ãŒæ‚ªã„äºº</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-4 h-4 bg-[#e5e7eb] border-2 border-[#9ca3af] rounded"></div>
                        <span class="ml-1 text-sm font-medium text-gray-700">ä½¿ã‚ãªã„</span>
                    </div>
                </div>
            </div>

            <!-- å³å´: ç”Ÿå¾’æƒ…å ±ã¨æ“ä½œ (5ã‚«ãƒ©ãƒ å¹…) -->
            <div class="lg:col-span-5 flex flex-col gap-6 h-full">

                <!-- ç”Ÿå¾’æƒ…å ±ã®è¿½åŠ  -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">2. ç”Ÿå¾’ã®è¿½åŠ </h2>

                    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="flex space-x-4 border-b border-gray-200 mb-4">
                        <button id="tab-btn-single"
                            class="pb-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600 transition-colors">å€‹åˆ¥è¿½åŠ </button>
                        <button id="tab-btn-bulk"
                            class="pb-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors">ã‚¨ã‚¯ã‚»ãƒ«ä¸€æ‹¬</button>
                    </div>

                    <!-- å€‹åˆ¥è¿½åŠ ã‚¿ãƒ– -->
                    <div id="tab-single" class="space-y-4">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-grow">
                                <label class="block text-sm font-medium text-gray-700 mb-1">åå‰</label>
                                <input type="text" id="student-name" placeholder="ä¾‹: å±±ç”° å¤ªéƒ"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                                <div class="flex bg-gray-100 p-1 rounded-lg">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="gender" value="boy" class="peer sr-only" checked>
                                        <div
                                            class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm">
                                            ç”·å­</div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="gender" value="girl" class="peer sr-only">
                                        <div
                                            class="px-3 py-1 rounded-md text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:text-pink-600 peer-checked:shadow-sm">
                                            å¥³å­</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="student-needs-front"
                                    class="form-checkbox h-5 w-5 text-emerald-500 rounded border-gray-300 focus:ring-emerald-500">
                                <span class="ml-2 text-sm font-medium text-gray-700">ç›®ãŒæ‚ªã„ï¼ˆå„ªå…ˆå¸­ï¼‰</span>
                            </label>
                            <button id="add-student"
                                class="bg-gray-800 hover:bg-gray-900 text-white font-medium py-2 px-6 rounded-lg transition-colors shadow-sm">è¿½åŠ </button>
                        </div>
                    </div>

                    <!-- ä¸€æ‹¬è¿½åŠ ã‚¿ãƒ– -->
                    <div id="tab-bulk" class="hidden space-y-4">
                        <p class="text-xs text-gray-600">ã‚¨ã‚¯ã‚»ãƒ«ç­‰ã®è¡¨ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>ã€åå‰ã€‘ ã€æ€§åˆ¥(ç”·/å¥³)ã€‘ ã€ç›®ãŒæ‚ªã„(ã€‡ãªã©)ã€‘</p>
                        <textarea id="bulk-input" rows="4"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="å±±ç”°å¤ªéƒ&#9;ç”·&#9;ã€‡&#10;ä½è—¤èŠ±å­&#9;å¥³&#10;éˆ´æœ¨ä¸€éƒ&#9;ç”·"></textarea>
                        <button id="add-bulk-student"
                            class="w-full bg-gray-800 hover:bg-gray-900 text-white font-medium py-2 rounded-lg transition-colors shadow-sm">ä¸€æ‹¬è¿½åŠ ã™ã‚‹</button>
                    </div>
                </div>

                <!-- ç”Ÿå¾’ãƒªã‚¹ãƒˆ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">ç”Ÿå¾’ãƒªã‚¹ãƒˆ</h2>
                        <div class="text-sm font-medium text-gray-500">
                            è¨ˆ: <span id="total-count">0</span>å (ç”·:<span id="boy-count">0</span> å¥³:<span
                                id="girl-count">0</span>)
                        </div>
                    </div>

                    <div class="flex-grow overflow-hidden flex flex-col border border-gray-200 rounded-xl">
                        <div class="overflow-y-auto max-h-[250px] lg:max-h-full">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase">åå‰
                                        </th>
                                        <th
                                            class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase w-16">
                                            æ€§åˆ¥</th>
                                        <th
                                            class="px-3 py-2 text-center text-xs font-semibold text-gray-600 uppercase w-16">
                                            è¦–åŠ›</th>
                                        <th
                                            class="px-3 py-2 text-left text-xs font-semibold text-gray-600 uppercase w-16">
                                            åº§å¸­</th>
                                        <th
                                            class="px-3 py-2 text-center text-xs font-semibold text-gray-600 uppercase w-12">
                                            å‰Š</th>
                                    </tr>
                                </thead>
                                <tbody id="student-list" class="bg-white divide-y divide-gray-100">
                                    <!-- ç”Ÿå¾’ãƒªã‚¹ãƒˆãŒã“ã“ã«å…¥ã‚Šã¾ã™ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="grid grid-cols-2 gap-4">
                    <button id="assign-seats"
                        class="col-span-2 sm:col-span-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-md transform transition hover:-translate-y-0.5">
                        ãƒ©ãƒ³ãƒ€ãƒ ã«å¸­æ›¿ãˆ
                    </button>
                    <button id="reset-all"
                        class="col-span-2 sm:col-span-1 bg-white border border-red-200 text-red-600 hover:bg-red-50 font-medium py-3 px-6 rounded-xl transition-colors">
                        ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- çŠ¶æ…‹ç®¡ç† ---
            let rows = 6;
            let cols = 6;
            let seats = [];    // åº§å¸­ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—
            let students = []; // ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—

            // --- DOMè¦ç´ ã®å–å¾— ---
            const classroom = document.getElementById('classroom');
            const studentNameInput = document.getElementById('student-name');
            const studentNeedsFrontInput = document.getElementById('student-needs-front');
            const addStudentBtn = document.getElementById('add-student');
            const bulkInput = document.getElementById('bulk-input');
            const addBulkStudentBtn = document.getElementById('add-bulk-student');
            const studentListTbody = document.getElementById('student-list');
            const assignSeatsBtn = document.getElementById('assign-seats');
            const resetAllBtn = document.getElementById('reset-all');
            const applyGridBtn = document.getElementById('apply-grid');

            // ã‚¿ãƒ–
            const tabBtnSingle = document.getElementById('tab-btn-single');
            const tabBtnBulk = document.getElementById('tab-btn-bulk');
            const tabSingle = document.getElementById('tab-single');
            const tabBulk = document.getElementById('tab-bulk');

            // ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºç”¨
            const totalCountEl = document.getElementById('total-count');
            const boyCountEl = document.getElementById('boy-count');
            const girlCountEl = document.getElementById('girl-count');

            // å¸­ã®ç¨®é¡ï¼ˆãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é †ï¼‰
            const seatTypes = ['empty', 'boy', 'girl', 'front', 'none'];

            // --- 1. ã‚°ãƒªãƒƒãƒ‰ã®åˆæœŸåŒ–ã¨é©ç”¨ ---
            function initClassroom(keepOldSeats = false) {
                const oldSeats = [...seats];
                classroom.innerHTML = '';
                classroom.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
                seats = [];

                for (let i = 0; i < rows; i++) {
                    for (let j = 0; j < cols; j++) {
                        const seatId = `${i}-${j}`;

                        // å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
                        const oldSeat = keepOldSeats ? oldSeats.find(s => s.row === i && s.col === j) : null;

                        const seatEl = document.createElement('div');
                        seatEl.className = 'seat empty';

                        const seatData = {
                            id: seatId,
                            row: i,
                            col: j,
                            type: oldSeat ? oldSeat.type : 'empty',
                            studentId: oldSeat ? oldSeat.studentId : null,
                            element: seatEl
                        };

                        setupSeatEvents(seatData);
                        seats.push(seatData);
                        classroom.appendChild(seatEl);
                        updateSeatUI(seatData);
                    }
                }

                // ã¯ã¿å‡ºãŸå¸­ã«åº§ã£ã¦ã„ãŸç”Ÿå¾’ã‚’ã€Œæœªå®šã€ã«ã™ã‚‹
                if (keepOldSeats) {
                    students.forEach(student => {
                        if (student.seatId) {
                            if (!seats.find(s => s.id === student.seatId)) {
                                student.seatId = null;
                            }
                        }
                    });
                }
            }

            // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³
            applyGridBtn.addEventListener('click', () => {
                const newRows = parseInt(document.getElementById('grid-rows').value);
                const newCols = parseInt(document.getElementById('grid-cols').value);

                if (isNaN(newRows) || newRows < 1 || isNaN(newCols) || newCols < 1) {
                    alert('æ­£ã—ã„è¡Œæ•°ãƒ»åˆ—æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                rows = newRows;
                cols = newCols;
                initClassroom(true);
                updateStudentListUI();
            });

            // --- 2. å¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼†ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰ ---
            function setupSeatEvents(seatData) {
                const el = seatData.element;

                // ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
                el.addEventListener('click', () => {
                    const currentIndex = seatTypes.indexOf(seatData.type);
                    seatData.type = seatTypes[(currentIndex + 1) % seatTypes.length];

                    // ä½¿ã‚ãªã„å¸­ã«ãªã£ãŸã€ã¾ãŸã¯æ—¢ã«ç”Ÿå¾’ãŒã„ã‚‹å ´åˆã¯è§£é™¤
                    if (seatData.type === 'none' || seatData.studentId) {
                        if (seatData.studentId) {
                            const student = students.find(s => s.id === seatData.studentId);
                            if (student) student.seatId = null;
                            seatData.studentId = null;
                            updateStudentListUI();
                        }
                    }
                    updateSeatUI(seatData);
                });

                // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å®Ÿè£…
                el.addEventListener('dragstart', (e) => {
                    if (seatData.type === 'none') {
                        e.preventDefault();
                        return;
                    }
                    e.dataTransfer.setData('text/plain', seatData.id);
                    e.dataTransfer.effectAllowed = 'move';
                    el.classList.add('dragging');
                });

                el.addEventListener('dragend', (e) => {
                    el.classList.remove('dragging');
                    document.querySelectorAll('.seat').forEach(s => s.classList.remove('drag-over'));
                });

                el.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (seatData.type === 'none') return;
                    e.dataTransfer.dropEffect = 'move';
                });

                el.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (seatData.type === 'none') return;
                    el.classList.add('drag-over');
                });

                el.addEventListener('dragleave', (e) => {
                    el.classList.remove('drag-over');
                });

                el.addEventListener('drop', (e) => {
                    e.preventDefault();
                    el.classList.remove('drag-over');
                    if (seatData.type === 'none') return;

                    const sourceId = e.dataTransfer.getData('text/plain');
                    if (sourceId === seatData.id) return; // åŒã˜å¸­

                    const sourceSeat = seats.find(s => s.id === sourceId);
                    if (!sourceSeat) return;

                    // ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®IDã‚’ã‚¹ãƒ¯ãƒƒãƒ—ã™ã‚‹
                    const tempStudentId = sourceSeat.studentId;
                    sourceSeat.studentId = seatData.studentId;
                    seatData.studentId = tempStudentId;

                    // ç”Ÿå¾’å´ã®å‚ç…§ã‚’æ›´æ–°
                    if (sourceSeat.studentId) {
                        const s1 = students.find(s => s.id === sourceSeat.studentId);
                        if (s1) s1.seatId = sourceSeat.id;
                    }
                    if (seatData.studentId) {
                        const s2 = students.find(s => s.id === seatData.studentId);
                        if (s2) s2.seatId = seatData.id;
                    }

                    updateSeatUI(sourceSeat);
                    updateSeatUI(seatData);
                    updateStudentListUI();
                });
            }

            // --- 3. åº§å¸­ã®è¦‹ãŸç›®ã‚’æ›´æ–° ---
            function updateSeatUI(seatData) {
                const el = seatData.element;
                el.className = `seat ${seatData.type}`;

                // ä½¿ã‚ãªã„å¸­ã®å ´åˆã¯ãƒ‰ãƒ©ãƒƒã‚°ç„¡åŠ¹ã€ãƒãƒ„å°
                if (seatData.type === 'none') {
                    el.setAttribute('draggable', 'false');
                    el.innerHTML = `<span class="text-gray-400 font-bold text-xl">Ã—</span>`;
                    return;
                }

                // æœ‰åŠ¹ãªå¸­ã¯ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
                el.setAttribute('draggable', 'true');

                const rowNum = seatData.row + 1;
                const colNum = seatData.col + 1;
                let innerHTML = `<span class="seat-number">${rowNum}-${colNum}</span>`;

                if (seatData.studentId) {
                    const student = students.find(s => s.id === seatData.studentId);
                    if (student) {
                        innerHTML += `<span class="seat-name">${student.name}</span>`;
                    }
                } else if (seatData.type !== 'empty') {
                    // å±æ€§ä»˜ãã®ç©ºå¸­
                    let lbl = seatData.type === 'boy' ? 'ç”·å­' : (seatData.type === 'girl' ? 'å¥³å­' : 'å„ªå…ˆ');
                    let color = seatData.type === 'boy' ? 'text-blue-300' : (seatData.type === 'girl' ? 'text-pink-300' : 'text-emerald-300');
                    innerHTML += `<span class="text-xs ${color} font-medium">${lbl}</span>`;
                }
                el.innerHTML = innerHTML;
            }

            // --- 4. ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ ---
            function switchTab(mode) {
                if (mode === 'single') {
                    tabBtnSingle.className = "pb-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600 transition-colors";
                    tabBtnBulk.className = "pb-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors";
                    tabSingle.classList.remove('hidden');
                    tabBulk.classList.add('hidden');
                } else {
                    tabBtnBulk.className = "pb-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600 transition-colors";
                    tabBtnSingle.className = "pb-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors";
                    tabBulk.classList.remove('hidden');
                    tabSingle.classList.add('hidden');
                }
            }
            tabBtnSingle.addEventListener('click', () => switchTab('single'));
            tabBtnBulk.addEventListener('click', () => switchTab('bulk'));

            // --- 5. ç”Ÿå¾’ã®è¿½åŠ å‡¦ç† ---

            // 5.1 å€‹åˆ¥è¿½åŠ 
            addStudentBtn.addEventListener('click', () => {
                const name = studentNameInput.value.trim();
                if (!name) {
                    alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    studentNameInput.focus();
                    return;
                }

                const genderInput = document.querySelector('input[name="gender"]:checked');
                const gender = genderInput ? genderInput.value : 'boy';
                const needsFront = studentNeedsFrontInput.checked;

                students.push({
                    id: 'student_' + Date.now() + Math.random(),
                    name: name,
                    gender: gender,
                    needsFront: needsFront,
                    seatId: null
                });

                updateStudentListUI();
                studentNameInput.value = '';
                studentNeedsFrontInput.checked = false;
                studentNameInput.focus();
            });

            studentNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addStudentBtn.click();
            });

            // 5.2 ä¸€æ‹¬è¿½åŠ 
            addBulkStudentBtn.addEventListener('click', () => {
                const text = bulkInput.value.trim();
                if (!text) {
                    alert('è¿½åŠ ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const lines = text.split('\n');
                let addedCount = 0;

                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;

                    // ã‚¿ãƒ–åŒºåˆ‡ã‚Šå„ªå…ˆã€ãªã‘ã‚Œã°ç©ºç™½åŒºåˆ‡ã‚Š
                    let parts = line.split('\t');
                    if (parts.length === 1) parts = line.split(/\s+/);

                    const name = parts[0];
                    let gender = 'boy';
                    let needsFront = false;

                    if (parts.length > 1) {
                        const gStr = parts[1].toLowerCase();
                        if (gStr === 'å¥³' || gStr === 'å¥³å­' || gStr === 'girl' || gStr === 'f') {
                            gender = 'girl';
                        }
                    }

                    if (parts.length > 2) {
                        const fStr = parts[2];
                        if (['ã€‡', 'â—‹', 'ä¸¸', '1', 'true', 'ã‚ã‚Š', 'æœ‰', 'å‰'].includes(fStr.toLowerCase())) {
                            needsFront = true;
                        }
                    }

                    students.push({
                        id: 'student_' + Date.now() + Math.random(),
                        name,
                        gender,
                        needsFront,
                        seatId: null
                    });
                    addedCount++;
                }

                if (addedCount > 0) {
                    updateStudentListUI();
                    bulkInput.value = '';
                    alert(`${addedCount}åã®ç”Ÿå¾’ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
                }
            });

            // --- 6. ç”Ÿå¾’ãƒªã‚¹ãƒˆUIã®æ›´æ–° ---
            function updateStudentListUI() {
                studentListTbody.innerHTML = '';

                const boyCount = students.filter(s => s.gender === 'boy').length;
                const girlCount = students.filter(s => s.gender === 'girl').length;
                totalCountEl.textContent = students.length;
                boyCountEl.textContent = boyCount;
                girlCountEl.textContent = girlCount;

                if (students.length === 0) {
                    studentListTbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-sm text-gray-500">
                                ç”Ÿå¾’ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                            </td>
                        </tr>
                    `;
                    return;
                }

                students.forEach(student => {
                    const tr = document.createElement('tr');

                    const genderBadge = student.gender === 'boy'
                        ? '<span class="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-xs font-bold border border-blue-100">ç”·å­</span>'
                        : '<span class="px-2 py-0.5 bg-pink-50 text-pink-600 rounded text-xs font-bold border border-pink-100">å¥³å­</span>';

                    const needsFrontCheck = `
                        <input type="checkbox" class="needs-front-toggle form-checkbox h-4 w-4 text-emerald-500 rounded border-gray-300" 
                               data-id="${student.id}" ${student.needsFront ? 'checked' : ''}>
                    `;

                    let seatText = '<span class="text-gray-400 text-xs">æœªå®š</span>';
                    if (student.seatId) {
                        const seat = seats.find(s => s.id === student.seatId);
                        if (seat) {
                            seatText = `<span class="font-medium text-gray-700">${seat.row + 1}-${seat.col + 1}</span>`;
                        }
                    }

                    tr.innerHTML = `
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-800">${student.name}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${genderBadge}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">${needsFrontCheck}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${seatText}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <button class="text-gray-400 hover:text-red-500 transition-colors p-1 btn-delete" data-id="${student.id}" title="å‰Šé™¤">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    `;

                    studentListTbody.appendChild(tr);
                });

                // è¦–åŠ›ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                document.querySelectorAll('.needs-front-toggle').forEach(chk => {
                    chk.addEventListener('change', (e) => {
                        const st = students.find(s => s.id === e.target.dataset.id);
                        if (st) st.needsFront = e.target.checked;
                    });
                });

                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const stId = e.currentTarget.dataset.id;
                        const st = students.find(s => s.id === stId);
                        if (st && st.seatId) {
                            const seat = seats.find(s => s.id === st.seatId);
                            if (seat) {
                                seat.studentId = null;
                                updateSeatUI(seat);
                            }
                        }
                        students = students.filter(s => s.id !== stId);
                        updateStudentListUI();
                    });
                });
            }

            // --- 7. ãƒ©ãƒ³ãƒ€ãƒ ã«å¸­æ›¿ãˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  ---
            assignSeatsBtn.addEventListener('click', () => {
                if (students.length === 0) {
                    alert('ç”Ÿå¾’ã‚’è¿½åŠ ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // 1. æœ‰åŠ¹ãªå¸­ã®æ•°ãƒã‚§ãƒƒã‚¯
                const activeSeats = seats.filter(s => s.type !== 'none');
                if (students.length > activeSeats.length) {
                    alert(`ç”Ÿå¾’ã®æ•°ï¼ˆ${students.length}äººï¼‰ãŒã€æœ‰åŠ¹ãªå¸­ã®æ•°ï¼ˆ${activeSeats.length}å¸­ï¼‰ã‚’ä¸Šå›ã£ã¦ã„ã¾ã™ã€‚åˆ—/è¡Œã‚’å¢—ã‚„ã™ã‹ã€ã€Œä½¿ã‚ãªã„ã€å¸­ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }

                // 2. ç¾åœ¨ã®å‰²ã‚Šå½“ã¦ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
                seats.forEach(s => s.studentId = null);
                students.forEach(s => s.seatId = null);

                // 3. é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–¢æ•°
                const shuffle = (array) => {
                    const arr = [...array];
                    for (let i = arr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [arr[i], arr[j]] = [arr[j], arr[i]];
                    }
                    return arr;
                };

                // 4. ç”Ÿå¾’ã¨å¸­ã®åˆ†é¡ï¼†ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                let reqFront = shuffle(students.filter(s => s.needsFront));
                let reqBoy = shuffle(students.filter(s => s.gender === 'boy' && !s.needsFront));
                let reqGirl = shuffle(students.filter(s => s.gender === 'girl' && !s.needsFront));

                let poolFront = shuffle(seats.filter(s => s.type === 'front'));
                let poolBoy = shuffle(seats.filter(s => s.type === 'boy'));
                let poolGirl = shuffle(seats.filter(s => s.type === 'girl'));
                let poolEmpty = shuffle(seats.filter(s => s.type === 'empty'));

                // å‰²ã‚Šå½“ã¦å®Ÿè¡Œé–¢æ•°
                const assign = (student, seat) => {
                    student.seatId = seat.id;
                    seat.studentId = student.id;
                };

                // 5. è¦–åŠ›å„ªå…ˆç”Ÿå¾’ã®å‰²ã‚Šå½“ã¦
                if (reqFront.length > poolFront.length) {
                    alert(`ç›®ãŒæ‚ªã„äººã®æ•°ï¼ˆ${reqFront.length}äººï¼‰ãŒã€è¨­å®šã•ã‚ŒãŸã€Œç›®ãŒæ‚ªã„äººç”¨ã€å¸­ã®æ•°ï¼ˆ${poolFront.length}å¸­ï¼‰ã‚’ä¸Šå›ã£ã¦ã„ã¾ã™ã€‚\nã¯ã¿å‡ºãŸäººã¯é€šå¸¸ã®å¸­ã«ãƒ©ãƒ³ãƒ€ãƒ ã§é…ç½®ã•ã‚Œã¾ã™ã€‚`);
                }

                reqFront.forEach(student => {
                    if (poolFront.length > 0) {
                        assign(student, poolFront.pop());
                    } else {
                        // å„ªå…ˆå¸­ãŒè¶³ã‚Šãªã„å ´åˆã€é€šå¸¸ãƒ—ãƒ¼ãƒ«ã¸åˆæµ
                        if (student.gender === 'boy') reqBoy.push(student);
                        else reqGirl.push(student);
                    }
                });

                // å„ªå…ˆå¸­ãŒä½™ã£ãŸå ´åˆã€èª°ã§ã‚‚åº§ã‚Œã‚‹é€šå¸¸ç©ºå¸­ãƒ—ãƒ¼ãƒ«ã«åˆæµ
                poolEmpty.push(...poolFront);
                poolEmpty = shuffle(poolEmpty);

                // 6. ç”·å­ã®å‰²ã‚Šå½“ã¦
                if (reqBoy.length > (poolBoy.length + poolEmpty.length)) {
                    alert('ç”·å­ç”Ÿå¾’ã®æ•°ãŒã€åº§ã‚Œã‚‹å¸­ï¼ˆç”·å­å¸­ï¼‹ç©ºå¸­ï¼‰ã‚’ä¸Šå›ã£ã¦ã„ã¾ã™ã€‚é…ç½®ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚');
                    // UIã ã‘æ›´æ–°ã—ã¦çµ‚äº†
                    seats.forEach(seat => updateSeatUI(seat));
                    updateStudentListUI();
                    return;
                }
                reqBoy.forEach(student => {
                    if (poolBoy.length > 0) {
                        assign(student, poolBoy.pop());
                    } else if (poolEmpty.length > 0) {
                        assign(student, poolEmpty.pop());
                    }
                });

                // 7. å¥³å­ã®å‰²ã‚Šå½“ã¦
                if (reqGirl.length > (poolGirl.length + poolEmpty.length)) {
                    alert('å¥³å­ç”Ÿå¾’ã®æ•°ãŒã€åº§ã‚Œã‚‹å¸­ï¼ˆå¥³å­å¸­ï¼‹ç©ºå¸­ï¼‰ã‚’ä¸Šå›ã£ã¦ã„ã¾ã™ã€‚é…ç½®ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚');
                    seats.forEach(seat => updateSeatUI(seat));
                    updateStudentListUI();
                    return;
                }
                reqGirl.forEach(student => {
                    if (poolGirl.length > 0) {
                        assign(student, poolGirl.pop());
                    } else if (poolEmpty.length > 0) {
                        assign(student, poolEmpty.pop());
                    }
                });

                // 8. UIã®æ›´æ–°
                seats.forEach(seat => updateSeatUI(seat));
                updateStudentListUI();
            });

            // --- 8. ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ ---
            resetAllBtn.addEventListener('click', () => {
                if (confirm('ç”Ÿå¾’ãƒªã‚¹ãƒˆã¨åº§å¸­ã®é…ç½®ã‚’ã™ã¹ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) {
                    students = [];
                    initClassroom(false); // ã‚°ãƒªãƒƒãƒ‰ã‚‚å®Œå…¨ã«åˆæœŸåŒ–
                    updateStudentListUI();
                }
            });

            // --- åˆæœŸåŒ–å‡¦ç†ã®å®Ÿè¡Œ ---
            initClassroom(false);
            updateStudentListUI();
        });
    </script>
</body>

</html>