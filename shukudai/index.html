<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宿題提出管理アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6; /* Tailwind bg-gray-100 */
        }
        .tab-button.active {
            border-color: #4f46e5; /* Tailwind indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px; /* Adjusted for better mobile view */
            border: 1px solid #d1d5db; /* Tailwind gray-300 */
            margin: 1rem auto;
            border-radius: 0.5rem; /* Tailwind rounded-lg */
        }
        .qr-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Tailwind shadow-sm */
        }
        .qr-item img, .qr-item canvas { 
            margin-bottom: 0.5rem;
            max-width: 100px; 
            max-height: 100px;
        }
        .qr-item p {
            font-size: 0.875rem; /* Tailwind text-sm */
            color: #374151; /* Tailwind gray-700 */
            text-align: center;
        }
        /* Table styling */
        .submission-table th, .submission-table td {
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            padding: 0.5rem; /* Tailwind p-2 */
            text-align: center;
            font-size: 0.75rem; /* Tailwind text-xs */
        }
        .submission-table th {
            background-color: #f9fafb; /* Tailwind gray-50 */
        }
        .submission-table td.submission-cell { 
            cursor: pointer; 
        }
        .submission-table td.submitted {
            background-color: #d1fae5; /* Tailwind green-100 */
            color: #065f46; /* Tailwind green-800 */
            font-weight: bold;
        }
        .submission-table tr.total-row td { /* Style for the total row */
            font-weight: bold;
            background-color: #eef2ff; /* Tailwind indigo-50 */
        }
        /* Responsive table container */
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        /* Custom modal for messages */
        .message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; 
        }
        .message-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            text-align: center;
            max-width: 90%;
        }
        .message-modal-content p {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8">
    <div class="container mx-auto max-w-5xl bg-white shadow-xl rounded-lg p-4 sm:p-6">
        <header class="mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-indigo-700">宿題提出管理アプリ</h1>
        </header>

        <div class="mb-6 border-b border-gray-300">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button id="tab-status-btn" class="tab-button active whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 font-medium text-sm rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
                    提出状況
                </button>
                <button id="tab-generator-btn" class="tab-button whitespace-nowrap px-3 py-2 sm:px-4 sm:py-3 font-medium text-sm rounded-t-lg border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
                    QRコード生成
                </button>
            </nav>
        </div>

        <main>
            <div id="content-status" class="tab-content active space-y-4">
                <h2 class="text-xl font-semibold text-gray-800">提出状況</h2>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 p-4 bg-gray-50 rounded-lg shadow">
                    <div class="flex items-center space-x-2">
                        <label for="submission-date" class="font-medium text-gray-700">日付:</label>
                        <input type="date" id="submission-date" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button id="start-scan-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150">
                        QR読み取り開始
                    </button>
                </div>
                <div id="qr-reader-section" style="display:none;" class="p-4 border border-gray-200 rounded-lg bg-white shadow">
                    <div id="qr-reader"></div>
                    <p id="qr-scan-status" class="mt-2 text-sm text-center text-gray-600">カメラでQRコードをスキャンしてください。</p>
                    <button id="stop-scan-btn" class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150" disabled>
                        読み取り停止
                    </button>
                </div>
                <div class="table-container mt-4 bg-white p-1 rounded-lg shadow">
                    <table id="submission-table" class="min-w-full w-full submission-table">
                        <thead>
                            <tr>
                                <th class="sticky left-0 bg-gray-50 z-10">出席番号</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="content-generator" class="tab-content space-y-6">
                <h2 class="text-xl font-semibold text-gray-800">QRコード生成</h2>
                <div class="space-y-4 p-4 bg-gray-50 rounded-lg shadow">
                    <div>
                        <label for="homework-type-select" class="block text-sm font-medium text-gray-700 mb-1">宿題タイプ:</label>
                        <select id="homework-type-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">出席番号:</label>
                        <div class="space-y-2 sm:space-y-0 sm:flex sm:items-center sm:space-x-4">
                            <div class="flex items-center">
                                <input id="select-all-students" name="student_selection_type" type="radio" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                                <label for="select-all-students" class="ml-2 block text-sm text-gray-900">全部 (1-<span id="max-student-label-all">42</span>)</label>
                            </div>
                            <div class="flex items-center">
                                <input id="select-range-students" name="student_selection_type" type="radio" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                <label for="select-range-students" class="ml-2 block text-sm text-gray-900">範囲指定:</label>
                            </div>
                            <div id="range-inputs" class="flex items-center space-x-2 hidden">
                                <input type="number" id="student-range-start" min="1" placeholder="開始" class="w-20 p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                                <span>～</span>
                                <input type="number" id="student-range-end" min="1" placeholder="終了" class="w-20 p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                            </div>
                        </div>
                    </div>
                    <button id="generate-qr-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150">
                        QRコード生成
                    </button>
                    <button id="show-qrs-btn" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150" style="display: none;"> 
                        生成したQRを表示
                    </button>
                </div>
                <div id="generated-qrs-container" class="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                </div>
            </div>
        </main>
    </div>

    <div id="message-modal" class="message-modal hidden">
        <div class="message-modal-content">
            <p id="message-modal-text"></p>
            <button id="message-modal-close-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md">閉じる</button>
        </div>
    </div>

    <script>
        // --- 定数 ---
        const HOMEWORK_TYPES = [ // MODIFIED: Added "休み"
            { name: "漢ド", code: "K1" }, { name: "計ド", code: "K2" },
            { name: "音読", code: "O" },  { name: "自勉強", code: "J" },
            { name: "その他1", code: "E1" },{ name: "その他2", code: "E2" },
            { name: "その他3", code: "E3" },{ name: "忘れ", code: "W1" },
            { name: "休み", code: "Y1" } // Added "休み"
        ];
        const MAX_STUDENTS = 42;
        const LOCAL_STORAGE_KEY = 'homeworkSubmissionData';

        // --- DOM要素 ---
        const tabStatusBtn = document.getElementById('tab-status-btn');
        const tabGeneratorBtn = document.getElementById('tab-generator-btn');
        const contentStatus = document.getElementById('content-status');
        const contentGenerator = document.getElementById('content-generator');
        
        const submissionDateInput = document.getElementById('submission-date');
        const startScanBtn = document.getElementById('start-scan-btn');
        const stopScanBtn = document.getElementById('stop-scan-btn');
        const qrReaderSection = document.getElementById('qr-reader-section');
        const qrScanStatus = document.getElementById('qr-scan-status');
        const submissionTable = document.getElementById('submission-table');
        const submissionTableHeadRow = submissionTable.querySelector('thead tr');
        const submissionTableBody = submissionTable.querySelector('tbody');

        const homeworkTypeSelectEl = document.getElementById('homework-type-select');
        const selectAllStudentsRadio = document.getElementById('select-all-students');
        const selectRangeStudentsRadio = document.getElementById('select-range-students');
        const rangeInputsDiv = document.getElementById('range-inputs');
        const studentRangeStartInput = document.getElementById('student-range-start');
        const studentRangeEndInput = document.getElementById('student-range-end');
        const generateQrBtn = document.getElementById('generate-qr-btn');
        const generatedQrsContainer = document.getElementById('generated-qrs-container');
        const showQrsBtn = document.getElementById('show-qrs-btn');
        const maxStudentLabelAll = document.getElementById('max-student-label-all');


        const messageModal = document.getElementById('message-modal');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalCloseBtn = document.getElementById('message-modal-close-btn');

        let html5QrCodeScanner;
        let submissionData = {};

        function initializeApp() {
            tabStatusBtn.addEventListener('click', () => switchTab('status'));
            tabGeneratorBtn.addEventListener('click', () => switchTab('generator'));
            
            maxStudentLabelAll.textContent = MAX_STUDENTS;
            studentRangeStartInput.max = MAX_STUDENTS;
            studentRangeEndInput.max = MAX_STUDENTS;

            initializeStatusTab();
            initializeGeneratorTab();
            messageModalCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));
            showQrsBtn.addEventListener('click', showGeneratedQRCodesInNewWindow); 
            switchTab('status');
        }

        function showMessage(message, isError = false) {
            messageModalText.textContent = message;
            messageModalText.className = isError ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';
            messageModal.classList.remove('hidden');
        }
        
        function switchTab(tabName) {
            contentStatus.classList.toggle('active', tabName === 'status');
            contentGenerator.classList.toggle('active', tabName === 'generator');
            tabStatusBtn.classList.toggle('active', tabName === 'status');
            tabGeneratorBtn.classList.toggle('active', tabName === 'generator');
            if (tabName === 'status') renderSubmissionTable();
        }

        function loadSubmissionData() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            submissionData = data ? JSON.parse(data) : {};
        }

        function saveSubmissionData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(submissionData));
        }

        function initializeStatusTab() {
            loadSubmissionData();
            const today = new Date().toISOString().split('T')[0];
            submissionDateInput.value = today;
            submissionDateInput.addEventListener('change', renderSubmissionTable);

            while (submissionTableHeadRow.children.length > 1) {
                submissionTableHeadRow.removeChild(submissionTableHeadRow.lastChild);
            }
            submissionTableBody.innerHTML = '';

            HOMEWORK_TYPES.forEach(hwType => {
                const th = document.createElement('th');
                th.textContent = hwType.name;
                submissionTableHeadRow.appendChild(th);
            });

            for (let i = 1; i <= MAX_STUDENTS; i++) {
                const tr = document.createElement('tr');
                const tdId = document.createElement('td');
                tdId.textContent = i;
                tdId.classList.add('sticky', 'left-0', 'bg-white', 'z-0'); 
                if (i % 2 === 0) tr.classList.add('bg-gray-50');
                tr.appendChild(tdId);

                HOMEWORK_TYPES.forEach((hwType, index) => {
                    const td = document.createElement('td');
                    const cellId = `s${i}-h${index}`; 
                    td.id = cellId;
                    td.classList.add('submission-cell'); 
                    td.dataset.studentId = i; 
                    td.dataset.homeworkIndex = index; 
                    td.addEventListener('click', handleManualCheck); 
                    tr.appendChild(td);
                });
                submissionTableBody.appendChild(tr);
            }
            
            // Add Total Row
            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row'); // Add class for styling
            const totalTh = document.createElement('td');
            totalTh.textContent = '合計';
            totalTh.classList.add('sticky', 'left-0', 'bg-indigo-50', 'z-0'); // Style for the "合計" cell
            totalRow.appendChild(totalTh);

            HOMEWORK_TYPES.forEach((hwType, index) => {
                const totalTd = document.createElement('td');
                totalTd.id = `total-h${index}`;
                totalRow.appendChild(totalTd);
            });
            submissionTableBody.appendChild(totalRow);

            renderSubmissionTable();
            startScanBtn.addEventListener('click', startQrScanner);
            stopScanBtn.addEventListener('click', stopQrScanner);
        }

        function handleManualCheck(event) {
            const cell = event.currentTarget;
            const studentId = parseInt(cell.dataset.studentId, 10);
            const homeworkIndex = parseInt(cell.dataset.homeworkIndex, 10);
            const selectedDate = submissionDateInput.value;

            if (!selectedDate) {
                showMessage("日付を選択してください。", true); return;
            }
            if (!submissionData[selectedDate]) submissionData[selectedDate] = {};
            const cellKey = `s${studentId}-h${homeworkIndex}`;
            submissionData[selectedDate][cellKey] = !submissionData[selectedDate][cellKey]; 
            saveSubmissionData();
            renderSubmissionTable(); 
        }

        function renderSubmissionTable() {
            const selectedDate = submissionDateInput.value;
            if (!selectedDate) return; 
            const dailyData = submissionData[selectedDate] || {};

            // Render student rows
            for (let i = 1; i <= MAX_STUDENTS; i++) {
                HOMEWORK_TYPES.forEach((hwType, index) => { 
                    const cellKey = `s${i}-h${index}`;
                    const cell = document.getElementById(cellKey);
                    if (cell) {
                        cell.textContent = dailyData[cellKey] ? '✔' : '';
                        cell.classList.toggle('submitted', !!dailyData[cellKey]);
                    }
                });
            }

            // Calculate and render totals
            HOMEWORK_TYPES.forEach((hwType, index) => {
                let count = 0;
                for (let i = 1; i <= MAX_STUDENTS; i++) {
                    const cellKey = `s${i}-h${index}`;
                    if (dailyData[cellKey]) {
                        count++;
                    }
                }
                const totalCell = document.getElementById(`total-h${index}`);
                if (totalCell) {
                    totalCell.textContent = count;
                }
            });
        }

        function startQrScanner() {
            qrReaderSection.style.display = 'block';
            startScanBtn.disabled = true;
            stopScanBtn.disabled = false; 
            qrScanStatus.textContent = "カメラを起動しています...";

            if (!html5QrCodeScanner) html5QrCodeScanner = new Html5Qrcode("qr-reader");
            
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                try {
                    const data = JSON.parse(decodedText);
                    if (data.h && typeof data.s !== 'undefined') { 
                        const studentId = parseInt(data.s, 10);
                        const homeworkCode = data.h; 
                        const homeworkObj = HOMEWORK_TYPES.find(hw => hw.code === homeworkCode);
                        if (!homeworkObj) {
                            qrScanStatus.textContent = "無効な宿題コードです。";
                            showMessage("無効な宿題コードです。", true); return;
                        }
                        const homeworkIndex = HOMEWORK_TYPES.indexOf(homeworkObj);
                        const homeworkName = homeworkObj.name;

                        if (studentId >= 1 && studentId <= MAX_STUDENTS && homeworkIndex !== -1) {
                            const selectedDate = submissionDateInput.value;
                            if (!selectedDate) {
                                qrScanStatus.textContent = "日付を選択してください。";
                                showMessage("記録する日付が選択されていません。", true); return;
                            }
                            if (!submissionData[selectedDate]) submissionData[selectedDate] = {};
                            const cellKey = `s${studentId}-h${homeworkIndex}`;
                            submissionData[selectedDate][cellKey] = true; 
                            saveSubmissionData();
                            renderSubmissionTable();
                            qrScanStatus.textContent = `出席番号${studentId}の「${homeworkName}」を記録しました。`;
                            showMessage(`出席番号${studentId}の「${homeworkName}」を記録しました。`);
                        } else {
                            qrScanStatus.textContent = "無効なQRコードデータです（生徒ID範囲外）。";
                            showMessage("無効なQRコードデータです。", true);
                        }
                    } else {
                        qrScanStatus.textContent = "QRコードの形式が正しくありません（hまたはs不明）。";
                        showMessage("QRコードの形式が正しくありません。", true);
                    }
                } catch (e) {
                    qrScanStatus.textContent = "QRコードの解析に失敗しました。";
                    console.error("QR Parse Error:", e, decodedText);
                    showMessage("QRコードの解析に失敗しました。", true);
                }
            };

            const config = { fps: 10, qrbox: { width: 250, height: 250 }}; 
            
            html5QrCodeScanner.start({ facingMode: "user" }, config, qrCodeSuccessCallback)
                .then(() => { qrScanStatus.textContent = "カメラでQRコードをスキャンしてください。"; })
                .catch(err => {
                    console.error("QR Scanner Start Error:", err);
                    qrScanStatus.textContent = "カメラの起動に失敗しました。";
                    qrReaderSection.style.display = 'none';
                    startScanBtn.disabled = false;
                    stopScanBtn.disabled = true; 
                    showMessage("カメラの起動に失敗しました。カメラへのアクセス許可を確認してください。", true);
                });
        }

        function stopQrScanner() {
            if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                html5QrCodeScanner.stop()
                    .then(() => { qrScanStatus.textContent = "スキャンを停止しました。"; })
                    .catch(err => {
                        console.error("Error stopping scanner:", err);
                        qrScanStatus.textContent = "スキャナー停止に失敗しました。";
                        showMessage("スキャナーの停止に失敗しました。", true);
                    })
                    .finally(() => {
                        qrReaderSection.style.display = 'none';
                        startScanBtn.disabled = false;
                        stopScanBtn.disabled = true; 
                    });
            } else {
                qrReaderSection.style.display = 'none';
                startScanBtn.disabled = false;
                stopScanBtn.disabled = true; 
            }
        }

        function initializeGeneratorTab() {
            homeworkTypeSelectEl.innerHTML = ''; 
            HOMEWORK_TYPES.forEach(hwType => {
                const option = document.createElement('option');
                option.value = hwType.code; 
                option.textContent = hwType.name; 
                homeworkTypeSelectEl.appendChild(option);
            });

            selectAllStudentsRadio.addEventListener('change', () => {
                rangeInputsDiv.classList.toggle('hidden', selectAllStudentsRadio.checked);
            });
            selectRangeStudentsRadio.addEventListener('change', () => {
                rangeInputsDiv.classList.toggle('hidden', !selectRangeStudentsRadio.checked);
            });
            generateQrBtn.addEventListener('click', generateQRCodes);
        }

        function generateQRCodes() {
            if (typeof QRCode === "undefined") {
                showMessage("QRコード生成ライブラリが読み込めていません。", true);
                console.error("QRCode library (qrcode.min.js) is not loaded."); return;
            }

            const selectedHomeworkCode = homeworkTypeSelectEl.value; 
            if (!selectedHomeworkCode) {
                showMessage("宿題タイプが選択されていません。", true); return;
            }
            const selectedHomeworkObj = HOMEWORK_TYPES.find(hw => hw.code === selectedHomeworkCode);
            const selectedHomeworkName = selectedHomeworkObj ? selectedHomeworkObj.name : "不明な宿題";

            let studentNumbers = [];
            if (selectAllStudentsRadio.checked) {
                for (let i = 1; i <= MAX_STUDENTS; i++) studentNumbers.push(i);
            } else if (selectRangeStudentsRadio.checked) {
                const start = parseInt(studentRangeStartInput.value, 10);
                const end = parseInt(studentRangeEndInput.value, 10);
                if (isNaN(start) || isNaN(end) || start < 1 || end > MAX_STUDENTS || start > end) {
                    showMessage(`出席番号の範囲指定が無効です。1から${MAX_STUDENTS}の間で正しく指定してください。`, true); return;
                }
                for (let i = start; i <= end; i++) studentNumbers.push(i);
            } else {
                 showMessage("出席番号の選択方法を選んでください。", true); return;
            }

            if (studentNumbers.length === 0) {
                showMessage("対象の生徒がいません。", true); return;
            }

            generatedQrsContainer.innerHTML = ''; 
            let generatedCount = 0;
            let errorCount = 0;

            studentNumbers.forEach(studentId => {
                const qrItemDiv = document.createElement('div');
                qrItemDiv.className = 'qr-item'; 
                
                const qrCodeDiv = document.createElement('div'); 
                qrItemDiv.appendChild(qrCodeDiv);

                const labelP = document.createElement('p');
                labelP.innerHTML = `出席番号: ${studentId}<br>宿題: ${selectedHomeworkName}`; 
                qrItemDiv.appendChild(labelP);
                generatedQrsContainer.appendChild(qrItemDiv);

                try {
                    const qrData = JSON.stringify({ h: selectedHomeworkCode, s: studentId }); 
                    new QRCode(qrCodeDiv, { 
                        text: qrData, width: 100, height: 100,
                        colorDark : "#000000", colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.L 
                    });
                    generatedCount++;
                } catch (e) {
                    console.error(`QR生成エラー(生徒ID:${studentId}, 宿題コード:${selectedHomeworkCode}):`, e);
                    errorCount++;
                    qrCodeDiv.innerHTML = `<span class="text-xs text-red-600">生成エラー</span>`; 
                }
            });

            if (generatedCount > 0) {
                showQrsBtn.style.display = 'block';
            } else {
                showQrsBtn.style.display = 'none';
            }

            if (generatedCount > 0 && errorCount === 0) {
                 showMessage(`${generatedCount}件のQRコードを生成しました。`);
            } else if (generatedCount > 0 && errorCount > 0) {
                showMessage(`${generatedCount}件生成, ${errorCount}件エラー。詳細はコンソール確認。`, true);
            } else if (errorCount > 0) {
                showMessage(`全QR(${errorCount}件)生成エラー。詳細はコンソール確認。`, true);
            } else {
                showMessage("QRコードは生成されませんでした。", true);
            }
        }

        function showGeneratedQRCodesInNewWindow() {
            const qrItems = generatedQrsContainer.querySelectorAll('.qr-item');
            if (qrItems.length === 0) {
                showMessage("表示するQRコードがありません。", true);
                return;
            }

            let newWindowContent = `
                <html>
                <head>
                    <title>生成されたQRコード (印刷用)</title>
                    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500&display=swap" rel="stylesheet">
                    <style>
                        body { 
                            font-family: 'Noto Sans JP', sans-serif; 
                            margin: 10mm; 
                            background-color: #ffffff; 
                        }
                        .qr-print-header { 
                            text-align: center; 
                            font-size: 1.2em; 
                            margin-bottom: 15px; 
                            color: #000000; 
                        }
                        .qr-print-container { 
                            display: flex; 
                            flex-wrap: wrap; 
                            gap: 5mm 2mm; 
                            justify-content: flex-start; 
                        }
                        .qr-print-item {
                            background-color: white;
                            display: flex; 
                            flex-direction: column;
                            align-items: center; 
                            justify-content: space-between; 
                            border: 1px solid #cccccc; 
                            border-radius: 4px; 
                            width: calc((100% / 6) - 4mm); 
                            height: 38mm; 
                            box-sizing: border-box;
                            padding: 2mm;
                            page-break-inside: avoid; 
                            overflow: hidden; 
                        }
                        .qr-print-item img {
                            max-width: 25mm; 
                            max-height: 25mm;
                            margin-bottom: 1mm;
                        }
                        .qr-print-item p {
                            font-size: 7pt; 
                            text-align: center;
                            margin: 0;
                            color: #000000; 
                            line-height: 1.2;
                            word-break: break-word; 
                        }
                         @media print {
                            body { margin: 10mm; } 
                            .qr-print-header { display: none; } 
                        }
                    </style>
                </head>
                <body>
                    <h1 class="qr-print-header">生成されたQRコード</h1>
                    <div class="qr-print-container">
            `;

            qrItems.forEach(item => {
                const canvas = item.querySelector('canvas');
                const imgElement = item.querySelector('img'); 
                const labelP = item.querySelector('p');
                let qrImageSrc = '';

                if (canvas) {
                    qrImageSrc = canvas.toDataURL();
                } else if (imgElement && imgElement.src && !imgElement.src.startsWith('data:image/gif;base64')) { 
                    qrImageSrc = imgElement.src;
                }

                const labelHtml = labelP ? labelP.innerHTML : '';

                if (qrImageSrc) {
                    newWindowContent += `
                        <div class="qr-print-item">
                            <img src="${qrImageSrc}" alt="QR Code">
                            <p>${labelHtml}</p>
                        </div>
                    `;
                } else if (labelP) { 
                     newWindowContent += `
                        <div class="qr-print-item">
                            <p style="color:red;">QR画像エラー</p>
                            <p>${labelHtml}</p>
                        </div>
                    `;
                }
            });

            newWindowContent += `
                    </div>
                </body>
                </html>
            `;

            const newWindow = window.open("", "_blank");
            if (newWindow) {
                newWindow.document.open();
                newWindow.document.write(newWindowContent);
                newWindow.document.close();
                newWindow.focus(); 
            } else {
                showMessage("新しいウィンドウを開けませんでした。ポップアップブロックの設定を確認してください。", true);
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>