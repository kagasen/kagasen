<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊÄùËÄÉ„ÉÑ„Éº„É´</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 relative">
    <div id="root"></div>

    <!-- Babel standalone for JSX parsing -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- React App Script -->
    <script type="text/babel" data-type="module" data-plugins="transform-react-jsx">
        import React, { useState, useRef, useEffect } from 'https://esm.sh/react@18?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18/client?dev';
        import { StickyNote, Type, Image as ImageIcon, LayoutTemplate, Trash2, ArrowDownRight, ZoomIn, ZoomOut, Focus, Plus, MousePointer2, Hand, PenLine, Eraser, HelpCircle } from 'https://esm.sh/lucide-react@latest?deps=react@18';

        // --- ÂÆöÊï∞„Å®„Éá„Éº„Çø ---
        const STICKY_COLORS = [
            'bg-yellow-100 border-yellow-300',
            'bg-pink-100 border-pink-300',
            'bg-blue-100 border-blue-300',
            'bg-green-100 border-green-300',
            'bg-purple-100 border-purple-300'
        ];

        const TEMPLATES = [
            { id: 'x-chart', name: 'X„ÉÅ„É£„Éº„Éà (ÂàÜÈ°û)', width: 1000, height: 800 },
            { id: 'y-chart', name: 'Y„ÉÅ„É£„Éº„Éà (ÂàÜÈ°û)', width: 1000, height: 800 },
            { id: 'axis-chart', name: 'Â∫ßÊ®ôËª∏ (È†ÜÂ∫è‰ªò„Åë)', width: 1000, height: 1000 },
            { id: 'venn-diagram', name: '„Éô„É≥Âõ≥ (ÊØîËºÉ)', width: 1000, height: 700 },
            { id: 'pmi-chart', name: 'PMI„ÉÅ„É£„Éº„Éà (ÂàÜÊûê)', width: 1200, height: 800 },
            { id: 'kwl-chart', name: 'KWL„ÉÅ„É£„Éº„Éà (ÊåØ„ÇäËøî„Çä)', width: 1200, height: 800 },
            { id: 'jellyfish-chart', name: '„ÇØ„É©„Ç≤„ÉÅ„É£„Éº„Éà (Ë¶ãÈÄö„Åô)', width: 1000, height: 800 },
            { id: 'fishbone-diagram', name: '„Éï„Ç£„ÉÉ„Ç∑„É•„Éú„Éº„É≥Âõ≥ (ÊßãÈÄ†Âåñ)', width: 1200, height: 600 },
            { id: 'candy-chart', name: '„Ç≠„É£„É≥„Éá„Ç£„Éº„ÉÅ„É£„Éº„Éà (Âõ†ÊûúÈñ¢‰øÇ)', width: 1000, height: 500 },
            { id: 'pyramid-chart', name: '„Éî„É©„Éü„ÉÉ„Éâ„ÉÅ„É£„Éº„Éà (ÁÑ¶ÁÇπÂåñ)', width: 1000, height: 800 },
        ];

        // --- „ÉÜ„É≥„Éó„É¨„Éº„ÉàSVGÊèèÁîª„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà ---
        const TemplateSvg = ({ id }) => {
            switch (id) {
                case 'x-chart':
                    return (
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full">
                            <line x1="0" y1="0" x2="100" y2="100" stroke="#64748b" strokeWidth="1" />
                            <line x1="100" y1="0" x2="0" y2="100" stroke="#64748b" strokeWidth="1" />
                        </svg>
                    );
                case 'y-chart':
                    return (
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full">
                            <line x1="50" y1="50" x2="50" y2="100" stroke="#64748b" strokeWidth="1" />
                            <line x1="50" y1="50" x2="0" y2="0" stroke="#64748b" strokeWidth="1" />
                            <line x1="50" y1="50" x2="100" y2="0" stroke="#64748b" strokeWidth="1" />
                        </svg>
                    );
                case 'axis-chart':
                    return (
                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full">
                            <line x1="50" y1="5" x2="50" y2="95" stroke="#475569" strokeWidth="1" />
                            <line x1="5" y1="50" x2="95" y2="50" stroke="#475569" strokeWidth="1" />
                            <polygon points="50,0 45,8 55,8" fill="#475569" />
                            <polygon points="100,50 92,45 92,55" fill="#475569" />
                        </svg>
                    );
                case 'venn-diagram':
                    return (
                        <svg viewBox="0 0 200 120" preserveAspectRatio="xMidYMid meet" className="w-full h-full">
                            <circle cx="70" cy="60" r="50" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <circle cx="130" cy="60" r="50" fill="transparent" stroke="#64748b" strokeWidth="2" />
                        </svg>
                    );
                case 'pmi-chart':
                    return (
                        <svg viewBox="0 0 300 200" preserveAspectRatio="none" className="w-full h-full">
                            <line x1="100" y1="0" x2="100" y2="200" stroke="#64748b" strokeWidth="1" />
                            <line x1="200" y1="0" x2="200" y2="200" stroke="#64748b" strokeWidth="1" />
                            <line x1="0" y1="30" x2="300" y2="30" stroke="#64748b" strokeWidth="1" />
                            <text x="50" y="20" textAnchor="middle" fill="#333" fontSize="12" fontWeight="bold">P (ËâØ„ÅÑ„Å®„Åì„Çç)</text>
                            <text x="150" y="20" textAnchor="middle" fill="#333" fontSize="12" fontWeight="bold">M (ÊÇ™„ÅÑ„Å®„Åì„Çç)</text>
                            <text x="250" y="20" textAnchor="middle" fill="#333" fontSize="12" fontWeight="bold">I („Åä„ÇÇ„Åó„Çç„ÅÑ)</text>
                        </svg>
                    );
                case 'kwl-chart':
                    return (
                        <svg viewBox="0 0 300 200" preserveAspectRatio="none" className="w-full h-full">
                            <line x1="100" y1="0" x2="100" y2="200" stroke="#64748b" strokeWidth="1" />
                            <line x1="200" y1="0" x2="200" y2="200" stroke="#64748b" strokeWidth="1" />
                            <line x1="0" y1="30" x2="300" y2="30" stroke="#64748b" strokeWidth="1" />
                            <text x="50" y="20" textAnchor="middle" fill="#333" fontSize="12" fontWeight="bold">K (Áü•„Å£„Å¶„ÅÑ„Çã)</text>
                            <text x="150" y="20" textAnchor="middle" fill="#333" fontSize="12" fontWeight="bold">W (Áü•„Çä„Åü„ÅÑ)</text>
                            <text x="250" y="20" textAnchor="middle" fill="#333" fontSize="12" fontWeight="bold">L („Çè„Åã„Å£„Åü)</text>
                        </svg>
                    );
                case 'jellyfish-chart':
                    return (
                        <svg viewBox="0 0 400 230" preserveAspectRatio="none" className="w-full h-full">
                            <path d="M 100 120 L 100 60 Q 100 10 200 10 Q 300 10 300 60 L 300 120 Z" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <line x1="120" y1="120" x2="80" y2="150" stroke="#64748b" strokeWidth="2" />
                            <circle cx="80" cy="180" r="30" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <line x1="160" y1="120" x2="140" y2="150" stroke="#64748b" strokeWidth="2" />
                            <circle cx="140" cy="180" r="30" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <line x1="200" y1="120" x2="200" y2="150" stroke="#64748b" strokeWidth="2" />
                            <circle cx="200" cy="180" r="30" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <line x1="240" y1="120" x2="260" y2="150" stroke="#64748b" strokeWidth="2" />
                            <circle cx="260" cy="180" r="30" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <line x1="280" y1="120" x2="320" y2="150" stroke="#64748b" strokeWidth="2" />
                            <circle cx="320" cy="180" r="30" fill="transparent" stroke="#64748b" strokeWidth="2" />
                        </svg>
                    );
                case 'fishbone-diagram':
                    return (
                        <svg viewBox="0 0 700 300" preserveAspectRatio="none" className="w-full h-full">
                            <path d="M 500 70 L 500 230 C 650 230, 650 70, 500 70 Z" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <line x1="40" y1="150" x2="500" y2="150" stroke="#64748b" strokeWidth="2" />
                            <line x1="480" y1="150" x2="420" y2="30" stroke="#64748b" strokeWidth="2" />
                            <line x1="420" y1="30" x2="270" y2="30" stroke="#64748b" strokeWidth="2" />
                            <line x1="480" y1="150" x2="420" y2="270" stroke="#64748b" strokeWidth="2" />
                            <line x1="420" y1="270" x2="270" y2="270" stroke="#64748b" strokeWidth="2" />
                            <line x1="270" y1="150" x2="210" y2="30" stroke="#64748b" strokeWidth="2" />
                            <line x1="210" y1="30" x2="60" y2="30" stroke="#64748b" strokeWidth="2" />
                            <line x1="270" y1="150" x2="210" y2="270" stroke="#64748b" strokeWidth="2" />
                            <line x1="210" y1="270" x2="60" y2="270" stroke="#64748b" strokeWidth="2" />
                        </svg>
                    );
                case 'candy-chart':
                    return (
                        <svg viewBox="0 0 300 120" preserveAspectRatio="none" className="w-full h-full">
                            <polygon points="100,60 20,20 20,100" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <polygon points="200,60 280,20 280,100" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <ellipse cx="150" cy="60" rx="60" ry="40" fill="transparent" stroke="#64748b" strokeWidth="2" />
                        </svg>
                    );
                case 'pyramid-chart':
                    return (
                        <svg viewBox="0 0 200 200" preserveAspectRatio="none" className="w-full h-full">
                            <polygon points="100,10 10,190 190,190" fill="transparent" stroke="#64748b" strokeWidth="2" />
                            <line x1="70" y1="70" x2="130" y2="70" stroke="#64748b" strokeWidth="2" />
                            <line x1="40" y1="130" x2="160" y2="130" stroke="#64748b" strokeWidth="2" />
                        </svg>
                    );
                default:
                    return null;
            }
        };

        // --- Â±•Ê≠¥ÁÆ°ÁêÜ„Éï„ÉÉ„ÇØ ---
        function useHistory(initialState) {
            const [past, setPast] = useState([]);
            const [present, setPresent] = useState(initialState);
            const [future, setFuture] = useState([]);

            const canUndo = past.length > 0;
            const canRedo = future.length > 0;

            const undo = () => {
                if (!canUndo) return;
                const previous = past[past.length - 1];
                const newPast = past.slice(0, past.length - 1);
                setPast(newPast);
                setFuture([present, ...future]);
                setPresent(previous);
            };

            const redo = () => {
                if (!canRedo) return;
                const next = future[0];
                const newFuture = future.slice(1);
                setPast([...past, present]);
                setFuture(newFuture);
                setPresent(next);
            };

            const set = (newPresent) => {
                if (newPresent === present) return;
                setPast([...past, present]);
                setPresent(newPresent);
                setFuture([]);
            };

            return { state: present, set, undo, redo, canUndo, canRedo };
        }

        // --- „Ç´„Çπ„Çø„É†„Ç´„Éº„ÇΩ„É´Áî®URLÂÆöÁæ© ---
        const penCursorUrl = `url('data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>')}') 0 24, crosshair`;
        const eraserCursorUrl = `url('data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></svg>')}') 0 24, cell`;

        // --- „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ ---
        function App() {
            // itemsState„ÅßÂ±•Ê≠¥ÁÆ°ÁêÜ„ÇíË°å„ÅÜ
            const { state: items, set: setItems, undo, redo, canUndo, canRedo } = useHistory([]);
            const [connections, setConnections] = useState([]);
            const [selectedIds, setSelectedIds] = useState([]);
            const [editingId, setEditingId] = useState(null);
            const [view, setView] = useState({ x: 0, y: 0, scale: 1 });
            const [isPanning, setIsPanning] = useState(false);
            const [maxZIndex, setMaxZIndex] = useState(2);
            const [showTemplateModal, setShowTemplateModal] = useState(false);
            const [showTutorialModal, setShowTutorialModal] = useState(false);
            const [tutorialImage, setTutorialImage] = useState(null);
            const [toolMode, setToolMode] = useState('pan'); // 'select', 'pan', 'draw', 'eraser'
            const [selectionBox, setSelectionBox] = useState(null);
            const [drawColor, setDrawColor] = useState('#ef4444'); // „Éö„É≥„Ç´„É©„ÉºÂàùÊúüÂÄ§ÔºàËµ§Ôºâ
            const [currentDrawingPath, setCurrentDrawingPath] = useState(null); // ÊèèÁîª‰∏≠„ÅÆ„Éë„Çπ

            const fileInputRef = useRef(null);
            const viewRef = useRef(view);
            const itemsRef = useRef(items);
            const maxZIndexRef = useRef(maxZIndex);
            const selectedIdsRef = useRef(selectedIds);
            const drawColorRef = useRef(drawColor);

            useEffect(() => { viewRef.current = view; }, [view]);
            useEffect(() => { drawColorRef.current = drawColor; }, [drawColor]);
            useEffect(() => {
                itemsRef.current = items;
            }, [items]);
            useEffect(() => { maxZIndexRef.current = maxZIndex; }, [maxZIndex]);
            useEffect(() => { selectedIdsRef.current = selectedIds; }, [selectedIds]);

            // „Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Ç≠„Éº„ÅÆÂÆüË£ÖÔºàCmd+Z / Ctrl+ZÔºâ
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'z') {
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [undo, redo]);

            const getCanvasCenter = () => {
                const w = window.innerWidth;
                const h = window.innerHeight;
                const v = viewRef.current;
                return {
                    x: (w / 2 - v.x) / v.scale,
                    y: (h / 2 - v.y) / v.scale,
                };
            };

            const bringToFront = (ids) => {
                const newZ = maxZIndexRef.current + 1;
                setMaxZIndex(newZ);
                // Â±•Ê≠¥„Å´ÊÆã„Åï„ÅöZ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å†„ÅëÊõ¥Êñ∞„Åó„Åü„ÅÑÂ†¥Âêà„ÅØsetItems„Çí‰Ωø„ÅÑ„Åæ„Åô„Åå„ÄÅ
                // Z„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥„ÇÇÁä∂ÊÖã„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇ
                setItems(items.map(item => ids.includes(item.id) ? { ...item, zIndex: newZ } : item));
                setSelectedIds(ids);
            };

            const updateItem = (id, changes) => {
                setItems(items.map(item => item.id === id ? { ...item, ...changes } : item));
            };

            const toggleLockSelected = () => {
                if (selectedIds.length === 0) return;
                const firstItem = items.find(i => i.id === selectedIds[0]);
                if (!firstItem) return;
                const newLockedStat = !firstItem.isLocked;
                setItems(items.map(item => selectedIds.includes(item.id) ? { ...item, isLocked: newLockedStat } : item));
            };

            const deleteSelected = () => {
                setItems(items.filter(item => !selectedIds.includes(item.id)));
                setConnections(prev => prev.filter(conn => !selectedIds.includes(conn.from) && !selectedIds.includes(conn.to)));
                setSelectedIds([]);
            };

            const deleteAll = () => {
                if (window.confirm("„Åô„Åπ„Å¶„ÅÆ„Ç¢„Ç§„ÉÜ„É†„Å®Áπã„Åå„Çä„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) {
                    setItems([]);
                    setConnections([]);
                    setSelectedIds([]);
                }
            };



            const addSticky = () => {
                const center = getCanvasCenter();
                const color = STICKY_COLORS[0];
                const newZ = maxZIndexRef.current + 1;
                setMaxZIndex(newZ);
                const offset = (items.length % 10) * 10;
                setItems([...items, {
                    id: `sticky-${Date.now()}`,
                    type: 'sticky',
                    content: '',
                    color,
                    x: center.x - 75 + offset, y: center.y - 30 + offset,
                    width: 150, height: 100,
                    zIndex: newZ,
                    isLocked: false
                }]);
            };

            const addText = () => {
                const center = getCanvasCenter();
                const newZ = maxZIndexRef.current + 1;
                setMaxZIndex(newZ);
                const offset = (items.length % 10) * 10;
                setItems([...items, {
                    id: `text-${Date.now()}`,
                    type: 'text',
                    content: '',
                    x: center.x - 150 + offset, y: center.y - 50 + offset,
                    width: 300, height: 100,
                    zIndex: newZ,
                    isLocked: false
                }]);
            };

            const addTemplate = (templateId) => {
                const tpl = TEMPLATES.find(t => t.id === templateId);
                const center = getCanvasCenter();
                const newZ = maxZIndexRef.current + 1;
                setMaxZIndex(newZ);
                setItems([...items, {
                    id: `tpl-${Date.now()}`,
                    type: 'template',
                    content: tpl.id,
                    x: center.x - tpl.width / 2, y: center.y - tpl.height / 2,
                    width: tpl.width, height: tpl.height,
                    zIndex: newZ,
                    isLocked: false
                }]);
                setShowTemplateModal(false);
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const dataUrl = event.target.result;
                    const img = new Image();
                    img.onload = () => {
                        let w = img.width;
                        let h = img.height;
                        if (w > 400) { h = h * (400 / w); w = 400; }
                        const center = getCanvasCenter();
                        const newZ = maxZIndexRef.current + 1;
                        setMaxZIndex(newZ);
                        setItems([...items, {
                            id: `img-${Date.now()}`,
                            type: 'image',
                            content: dataUrl,
                            x: center.x - w / 2, y: center.y - h / 2,
                            width: w, height: h,
                            zIndex: newZ,
                            isLocked: false
                        }]);
                    };
                    img.src = dataUrl;
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            };

            const connectNewSticky = (sourceItem) => {
                const newId = `sticky-${Date.now()}`;
                const color = sourceItem.color || STICKY_COLORS[0];
                const newZ = maxZIndexRef.current + 1;
                setMaxZIndex(newZ);

                const h = sourceItem.height || 100;
                const newX = sourceItem.x;
                const newY = sourceItem.y + h + 15; // 40„Åã„Çâ15„Å´Â§âÊõ¥„ÅóÈñìÈöî„ÇíÁã≠„ÇÅ„Çã

                const newItem = {
                    id: newId,
                    type: 'sticky',
                    content: '',
                    color,
                    x: newX, y: newY,
                    width: 150, height: 100,
                    zIndex: newZ,
                    isLocked: false
                };

                setItems([...items, newItem]);
                setConnections(prev => [...prev, { from: sourceItem.id, to: newId }]);
                setSelectedIds([newId]);
                setEditingId(newId);
            };

            const handleCanvasPointerDown = (e) => {
                if (e.target.closest('[data-item]') && toolMode !== 'draw') return;

                if (toolMode !== 'draw') {
                    setSelectedIds([]);
                    setEditingId(null);
                }

                if (toolMode === 'select') {
                    // ... selection logic ...
                    const startX = e.clientX;
                    const startY = e.clientY;
                    const startViewX = viewRef.current.x;
                    const startViewY = viewRef.current.y;
                    const scale = viewRef.current.scale;

                    const canvasStartX = (startX - startViewX) / scale;
                    const canvasStartY = (startY - startViewY) / scale;

                    const handlePointerMove = (moveEvent) => {
                        const currentX = (moveEvent.clientX - startViewX) / scale;
                        const currentY = (moveEvent.clientY - startViewY) / scale;

                        const minX = Math.min(canvasStartX, currentX);
                        const minY = Math.min(canvasStartY, currentY);
                        const maxX = Math.max(canvasStartX, currentX);
                        const maxY = Math.max(canvasStartY, currentY);

                        setSelectionBox({ x: minX, y: minY, w: maxX - minX, h: maxY - minY });

                        const newSelectedIds = itemsRef.current.filter(item => {
                            const iw = item.width || 100;
                            const ih = item.height || 100;
                            return (
                                item.x < minX + (maxX - minX) &&
                                item.x + iw > minX &&
                                item.y < minY + (maxY - minY) &&
                                item.y + ih > minY
                            );
                        }).map(i => i.id);
                        setSelectedIds(newSelectedIds);
                    };

                    const handlePointerUp = () => {
                        setSelectionBox(null);
                        document.removeEventListener('pointermove', handlePointerMove);
                        document.removeEventListener('pointerup', handlePointerUp);
                    };

                    document.addEventListener('pointermove', handlePointerMove);
                    document.addEventListener('pointerup', handlePointerUp);

                } else if (toolMode === 'pan') {
                    setIsPanning(true);
                    const startX = e.clientX;
                    const startY = e.clientY;
                    const startViewX = viewRef.current.x;
                    const startViewY = viewRef.current.y;

                    const handlePointerMove = (moveEvent) => {
                        const dx = moveEvent.clientX - startX;
                        const dy = moveEvent.clientY - startY;
                        setView({ ...viewRef.current, x: startViewX + dx, y: startViewY + dy });
                    };

                    const handlePointerUp = () => {
                        setIsPanning(false);
                        document.removeEventListener('pointermove', handlePointerMove);
                        document.removeEventListener('pointerup', handlePointerUp);
                    };

                    document.addEventListener('pointermove', handlePointerMove);
                    document.addEventListener('pointerup', handlePointerUp);

                } else if (toolMode === 'draw') {
                    const startX = e.clientX;
                    const startY = e.clientY;
                    const scale = viewRef.current.scale;

                    const canvasX = (startX - viewRef.current.x) / scale;
                    const canvasY = (startY - viewRef.current.y) / scale;

                    let pathData = `M ${canvasX} ${canvasY}`;
                    const currentDrawColor = drawColorRef.current;
                    const newId = `path-${Date.now()}`;

                    setCurrentDrawingPath({ id: newId, path: pathData, color: currentDrawColor, x: 0, y: 0 });

                    const handlePointerMove = (moveEvent) => {
                        const currentX = (moveEvent.clientX - viewRef.current.x) / scale;
                        const currentY = (moveEvent.clientY - viewRef.current.y) / scale;
                        pathData += ` L ${currentX} ${currentY}`;
                        setCurrentDrawingPath({ id: newId, path: pathData, color: currentDrawColor, x: 0, y: 0 });
                    };

                    const handlePointerUp = () => {
                        // PointerUp„Åó„Åü„ÇâÊúÄÁµÇ„Éë„Çπ„Çíitems„Å´ËøΩÂä†
                        setCurrentDrawingPath(prev => {
                            if (prev) {
                                const newZ = maxZIndexRef.current + 1;
                                setMaxZIndex(newZ);
                                const newPathItem = {
                                    id: prev.id,
                                    type: 'path',
                                    content: prev.path, // path„Éá„Éº„Çø„Çícontent„Å´ÊåÅ„Å§
                                    color: prev.color,
                                    x: 0, y: 0, width: 1, height: 1, // Âü∫Êú¨0,0„Åß„Éï„É´„Ç≠„É£„É≥„Éê„Çπ„Å´ÈÖçÁΩÆ
                                    zIndex: newZ,
                                    isLocked: true // „Éë„Çπ„ÅØÊúÄÂàù„ÅØÁßªÂãï‰∏çÂèØ„Å®„Åô„Çã„ÄÇ
                                };
                                setItems([...itemsRef.current, newPathItem]);
                            }
                            return null;
                        });
                        document.removeEventListener('pointermove', handlePointerMove);
                        document.removeEventListener('pointerup', handlePointerUp);
                    };

                    document.addEventListener('pointermove', handlePointerMove);
                    document.addEventListener('pointerup', handlePointerUp);
                }
            };

            const handleWheel = (e) => {
                const zoomSensitivity = 0.001;
                const delta = -e.deltaY * zoomSensitivity;
                const newScale = Math.min(Math.max(0.1, view.scale * (1 + delta)), 5);

                const mouseX = e.clientX;
                const mouseY = e.clientY;
                const newX = mouseX - (mouseX - view.x) * (newScale / view.scale);
                const newY = mouseY - (mouseY - view.y) * (newScale / view.scale);

                setView({ x: newX, y: newY, scale: newScale });
            };

            const handleItemDragStart = (e, id) => {
                e.stopPropagation();
                if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT' || e.target.closest('.lock-btn')) return;

                const targetItem = itemsRef.current.find(i => i.id === id);
                if (!targetItem || targetItem.isLocked) {
                    if (targetItem && targetItem.isLocked) setSelectedIds([id]);
                    return;
                }

                let dragTargetIds = selectedIdsRef.current;
                if (!dragTargetIds.includes(id)) {
                    dragTargetIds = [id];
                    setSelectedIds(dragTargetIds);
                }

                bringToFront(dragTargetIds);

                const startClientX = e.clientX;
                const startClientY = e.clientY;

                const startPositions = dragTargetIds.map(dragId => {
                    const item = itemsRef.current.find(i => i.id === dragId);
                    return item ? { id: dragId, x: item.x, y: item.y, isLocked: item.isLocked } : null;
                }).filter(p => p && !p.isLocked);

                const handlePointerMove = (moveEvent) => {
                    const scale = viewRef.current.scale;
                    const dx = (moveEvent.clientX - startClientX) / scale;
                    const dy = (moveEvent.clientY - startClientY) / scale;

                    setItems(itemsRef.current.map(item => {
                        const startPos = startPositions.find(p => p.id === item.id);
                        if (startPos) {
                            return { ...item, x: startPos.x + dx, y: startPos.y + dy };
                        }
                        return item;
                    }));
                };

                const handlePointerUp = () => {
                    document.removeEventListener('pointermove', handlePointerMove);
                    document.removeEventListener('pointerup', handlePointerUp);
                };

                document.addEventListener('pointermove', handlePointerMove);
                document.addEventListener('pointerup', handlePointerUp);
            };

            const handleItemResizeStart = (e, id) => {
                e.stopPropagation();

                const targetItem = itemsRef.current.find(i => i.id === id);
                if (!targetItem || targetItem.isLocked) return;

                let resizeTargetIds = selectedIdsRef.current;
                if (!resizeTargetIds.includes(id)) {
                    resizeTargetIds = [id];
                    setSelectedIds(resizeTargetIds);
                }

                bringToFront(resizeTargetIds);

                const startClientX = e.clientX;
                const startClientY = e.clientY;

                const startSizes = resizeTargetIds.map(resizeId => {
                    const item = itemsRef.current.find(i => i.id === resizeId);
                    return item ? { id: resizeId, w: item.width, h: item.height, isLocked: item.isLocked } : null;
                }).filter(s => s && !s.isLocked);

                const handlePointerMove = (moveEvent) => {
                    const scale = viewRef.current.scale;
                    const dx = (moveEvent.clientX - startClientX) / scale;
                    const dy = (moveEvent.clientY - startClientY) / scale;

                    setItems(itemsRef.current.map(item => {
                        const startSize = startSizes.find(s => s.id === item.id);
                        if (startSize) {
                            return {
                                ...item,
                                width: Math.max(100, startSize.w + dx),
                                height: Math.max(50, startSize.h + dy)
                            };
                        }
                        return item;
                    }));
                };

                const handlePointerUp = () => {
                    document.removeEventListener('pointermove', handlePointerMove);
                    document.removeEventListener('pointerup', handlePointerUp);
                };

                document.addEventListener('pointermove', handlePointerMove);
                document.addEventListener('pointerup', handlePointerUp);
            };

            return (
                <div
                    className="w-screen h-screen flex relative overflow-hidden text-slate-800"
                    style={{ fontFamily: '"Hiragino Maru Gothic ProN", "„Éí„É©„ÇÆ„Éé‰∏∏„Ç¥ ProN", "Meiryo", sans-serif' }}
                >
                    <div
                        className="w-full h-full absolute inset-0 touch-none"
                        onPointerDown={handleCanvasPointerDown}
                        onWheel={handleWheel}
                        style={{
                            cursor: toolMode === 'select' ? 'default' :
                                toolMode === 'pan' ? (isPanning ? 'grabbing' : 'grab') :
                                    toolMode === 'draw' ? penCursorUrl :
                                        toolMode === 'eraser' ? eraserCursorUrl : 'default',
                            backgroundColor: '#f8fafc',
                            backgroundImage: `radial-gradient(#cbd5e1 ${1 * view.scale}px, transparent ${1 * view.scale}px)`,
                            backgroundSize: `${20 * view.scale}px ${20 * view.scale}px`,
                            backgroundPosition: `${view.x}px ${view.y}px`,
                        }}
                    >
                        <div
                            className="absolute top-0 left-0 origin-top-left w-full h-full pointer-events-none"
                            style={{ transform: `translate(${view.x}px, ${view.y}px) scale(${view.scale})` }}
                        >
                            <svg className="absolute top-0 left-0 w-full h-full overflow-visible pointer-events-none" style={{ zIndex: 0 }}>
                                {connections.map((conn, idx) => {
                                    const fromItem = items.find(i => i.id === conn.from);
                                    const toItem = items.find(i => i.id === conn.to);
                                    if (!fromItem || !toItem) return null;

                                    const x1 = fromItem.x + (fromItem.width || 150) / 2;
                                    const y1 = fromItem.y + (fromItem.height || 100) / 2;
                                    const x2 = toItem.x + (toItem.width || 150) / 2;
                                    const y2 = toItem.y + (toItem.height || 100) / 2;

                                    return (
                                        <line
                                            key={idx}
                                            x1={x1} y1={y1} x2={x2} y2={y2}
                                            stroke="#475569" strokeWidth="3"
                                            strokeLinecap="round"
                                        />
                                    );
                                })}
                                {selectionBox && (
                                    <rect
                                        x={selectionBox.x}
                                        y={selectionBox.y}
                                        width={selectionBox.w}
                                        height={selectionBox.h}
                                        fill="rgba(59, 130, 246, 0.1)"
                                        stroke="rgba(59, 130, 246, 0.5)"
                                        strokeWidth="2"
                                        strokeDasharray="4 4"
                                    />
                                )}
                                {currentDrawingPath && (
                                    <path
                                        d={currentDrawingPath.path}
                                        fill="none"
                                        stroke={currentDrawingPath.color}
                                        strokeWidth="6"
                                        strokeLinecap="round"
                                        strokeLinejoin="round"
                                    />
                                )}
                            </svg>

                            {items.map(item => {
                                const isSelected = selectedIds.includes(item.id);
                                const isLocked = item.isLocked || false;

                                const renderZIndex = item.type === 'template'
                                    ? (isSelected ? item.zIndex + 1000 : item.zIndex)
                                    : (isSelected ? item.zIndex + 11000 : item.zIndex + 10000); // path Á≠â„ÅÆÂ†¥Âêà„ÅØ„ÉÜ„Ç≠„Çπ„Éà„Å®Âêå„ÅòZ„É¨„É≥„Ç∏

                                if (item.type === 'path') {
                                    // Path„ÅÆÂ†¥Âêà„ÅØSVGÂÜÖ„Å´Áõ¥Êé•ÊèèÁîª„Åô„ÇãÁâπÂà•„Å™„É©„ÉÉ„Éë„Éº„Å´„Åô„Çã
                                    return (
                                        <div
                                            key={item.id}
                                            id={`item-wrapper-${item.id}`}
                                            data-item="true"
                                            className={`absolute pointer-events-none group ${isSelected ? 'ring-4 ring-blue-400 ring-offset-2 rounded-xl' : ''}`}
                                            style={{
                                                left: 0, top: 0, width: 0, height: 0,
                                                zIndex: renderZIndex,
                                            }}
                                        >
                                            <svg className="absolute top-0 left-0 overflow-visible pointer-events-auto" style={{ width: '1px', height: '1px' }}>
                                                <path
                                                    d={item.content}
                                                    fill="none"
                                                    stroke={item.color}
                                                    strokeWidth="6"
                                                    strokeLinecap="round"
                                                    strokeLinejoin="round"
                                                    className={`hover:stroke-opacity-70 ${toolMode === 'eraser' ? 'cursor-cell' : isLocked ? 'cursor-default' : 'cursor-pointer'}`}
                                                    onPointerDown={(e) => {
                                                        if (toolMode === 'eraser') {
                                                            e.stopPropagation();
                                                            setItems(prev => prev.filter(i => i.id !== item.id));
                                                            return;
                                                        }
                                                        // „Éë„ÇπËá™Ë∫´„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÊôÇ„ÇÇÈÅ∏ÊäûÂèØËÉΩ„Å´„Åô„Çã
                                                        if (!isLocked) {
                                                            e.stopPropagation();
                                                            if (!e.shiftKey) setSelectedIds([item.id]);
                                                            else setSelectedIds([...selectedIds, item.id]);
                                                        } else {
                                                            setSelectedIds([item.id]);
                                                        }
                                                    }}
                                                    onPointerEnter={(e) => {
                                                        // „Éâ„É©„ÉÉ„Ç∞Áä∂ÊÖã„ÅßÊ∂à„Åó„Ç¥„É†„Åå„Éõ„Éê„Éº„Åó„ÅüÂ†¥Âêà„Å´Ê∂à„Åô
                                                        if (toolMode === 'eraser' && e.buttons === 1) {
                                                            e.stopPropagation();
                                                            setItems(prev => prev.filter(i => i.id !== item.id));
                                                        }
                                                    }}
                                                />
                                            </svg>
                                            {/* ÂâäÈô§„Éú„Çø„É≥Ôºà„Éë„ÇπÂ∞ÇÁî®Ôºâ */}
                                            {isSelected && !isLocked && (
                                                <div className="absolute z-50 pointer-events-auto" style={{ left: 20, top: 20 }}>
                                                    <button
                                                        className="bg-red-500 hover:bg-red-600 text-white rounded-full p-2 shadow-lg cursor-pointer transition-transform hover:scale-110"
                                                        onPointerDown={(e) => { e.stopPropagation(); deleteSelected(); }}
                                                        title="„Åï„Åè„Åò„Çá"
                                                    >
                                                        <Trash2 size={18} />
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    );
                                }

                                // ÂπÖ„Å´‰æùÂ≠ò„Åó„Åü„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÅÆË®àÁÆó (ÂàùÊúü„Çµ„Ç§„Ç∫„ÇíÂü∫Ê∫ñ„Å®„Åó„Åü„Çπ„Ç±„Éº„É´)
                                const baseFontSize = item.type === 'text' ? 24 : 18;
                                const baseWidth = item.type === 'text' ? 300 : 150;
                                const computedFontSize = Math.max(12, Math.floor(baseFontSize * (item.width / baseWidth)));

                                const isOnlySelected = selectedIds.length === 1 && isSelected;

                                return (
                                    <div
                                        key={item.id}
                                        id={`item-wrapper-${item.id}`}
                                        data-item="true"
                                        className={`absolute pointer-events-auto shadow-sm group ${isSelected ? 'ring-4 ring-blue-400 ring-offset-2 rounded-xl' : ''} ${isLocked ? 'ring-red-400 opacity-90' : ''}`}
                                        style={{
                                            left: item.x,
                                            top: item.y,
                                            width: item.width,
                                            height: item.height,
                                            zIndex: renderZIndex,
                                            cursor: isLocked ? 'not-allowed' : 'move'
                                        }}
                                        onPointerDown={(e) => handleItemDragStart(e, item.id)}
                                    >
                                        {/* „É≠„ÉÉ„ÇØ„Éà„Ç∞„É´„Éú„Çø„É≥ */}
                                        {isSelected && (
                                            <button
                                                className={`lock-btn absolute -top-4 left-4 ${isLocked ? 'bg-red-500 hover:bg-red-600' : 'bg-slate-500 hover:bg-slate-600'} text-white rounded-full p-2 z-50 shadow-lg transition-transform hover:scale-110 flex items-center justify-center`}
                                                onPointerDown={(e) => { e.stopPropagation(); toggleLockSelected(); }}
                                                title={isLocked ? "„É≠„ÉÉ„ÇØËß£Èô§" : "‰ΩçÁΩÆ„Çí„É≠„ÉÉ„ÇØ"}
                                                style={{ width: '34px', height: '34px', fontSize: '14px' }}
                                            >
                                                {isLocked ? 'üîí' : 'üîì'}
                                            </button>
                                        )}

                                        {/* ÂâäÈô§„Éú„Çø„É≥ */}
                                        {isSelected && !isLocked && (
                                            <button
                                                className="absolute -top-4 -right-4 bg-red-500 hover:bg-red-600 text-white rounded-full p-2 z-50 shadow-lg cursor-pointer transition-transform hover:scale-110"
                                                onPointerDown={(e) => { e.stopPropagation(); deleteSelected(); }}
                                                title="„Åï„Åè„Åò„Çá"
                                            >
                                                <Trash2 size={18} />
                                            </button>
                                        )}

                                        {/* Áπã„ÅêÔºàÔºãÔºâ„Éú„Çø„É≥Ôºà‰ªòÁÆã„ÅÆ„ÅøÔºâ */}
                                        {isOnlySelected && item.type === 'sticky' && !isLocked && (
                                            <button
                                                className="absolute top-1/2 -right-6 -translate-y-1/2 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-1.5 shadow-lg z-50 cursor-pointer transition-transform hover:scale-110"
                                                onPointerDown={(e) => { e.stopPropagation(); connectNewSticky(item); }}
                                                title="Êñ∞„Åó„ÅèÁπã„Åê"
                                            >
                                                <Plus size={20} />
                                            </button>
                                        )}

                                        {/* Ëâ≤Â§âÊõ¥„Éë„É¨„ÉÉ„ÉàÔºà‰ªòÁÆã„ÅÆ„ÅøÔºâ */}
                                        {isSelected && item.type === 'sticky' && !isLocked && (
                                            <div className="absolute -bottom-10 left-1/2 -translate-x-1/2 bg-white px-3 py-2 rounded-full shadow-lg border border-slate-200 flex gap-2 z-50 pointer-events-auto">
                                                {STICKY_COLORS.map(c => (
                                                    <button
                                                        key={c}
                                                        className={`w-6 h-6 rounded-full ${c.split(' ')[0]} border shadow-sm transition-transform hover:scale-110 ${item.color === c ? 'border-slate-800 scale-110 ring-2 ring-slate-400' : 'border-slate-200'}`}
                                                        onPointerDown={(e) => {
                                                            e.stopPropagation();
                                                            setItems(items.map(i => (selectedIds.includes(i.id) && i.type === 'sticky') ? { ...i, color: c } : i));
                                                        }}
                                                        title="Ëâ≤„Çí„Åã„Åà„Çã"
                                                    />
                                                ))}
                                            </div>
                                        )}

                                        {item.type === 'sticky' && (
                                            <div
                                                className={`w-full h-full ${item.color} border-2 p-3 rounded-lg shadow-md flex flex-col ${isLocked ? 'cursor-default pointer-events-none' : 'cursor-move'}`}
                                                onDoubleClick={() => !isLocked && setEditingId(item.id)}
                                                style={{ fontSize: `${computedFontSize}px` }}
                                            >
                                                {editingId === item.id ? (
                                                    <textarea
                                                        className="w-full h-full bg-transparent resize-none outline-none font-bold text-slate-800 overflow-hidden"
                                                        value={item.content}
                                                        onChange={(e) => updateItem(item.id, { content: e.target.value })}
                                                        onBlur={() => setEditingId(null)}
                                                        placeholder="„Åì„Åì„Å´ÂÖ•Âäõ..."
                                                        autoFocus
                                                    />
                                                ) : (
                                                    <div className="w-full h-full font-bold text-slate-800 whitespace-pre-wrap break-words select-none pointer-events-none flex items-start">
                                                        {item.content || <span className="text-black/30">„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÖ•Âäõ</span>}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {item.type === 'text' && (
                                            <div
                                                className={`w-full h-full flex flex-col p-2 ${isLocked ? 'cursor-default' : 'cursor-move'}`}
                                                onDoubleClick={() => !isLocked && setEditingId(item.id)}
                                                style={{ fontSize: `${computedFontSize}px`, lineHeight: 1.2 }}
                                            >
                                                {editingId === item.id ? (
                                                    <textarea
                                                        className="w-full h-full bg-transparent resize-none outline-none font-extrabold text-slate-700 overflow-hidden"
                                                        value={item.content}
                                                        onChange={(e) => updateItem(item.id, { content: e.target.value })}
                                                        onBlur={() => setEditingId(null)}
                                                        placeholder="„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ"
                                                        autoFocus
                                                    />
                                                ) : (
                                                    <div className="w-full h-full font-extrabold text-slate-700 whitespace-pre-wrap break-words select-none pointer-events-none">
                                                        {item.content || <span className="text-black/30">„ÉÜ„Ç≠„Çπ„Éà(„ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ)</span>}
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        {item.type === 'image' && (
                                            <div className="w-full h-full bg-white border-4 border-white shadow-md rounded pointer-events-none">
                                                <img src={item.content} alt="uploaded" className="w-full h-full object-contain" draggable={false} />
                                            </div>
                                        )}

                                        {item.type === 'template' && (
                                            <div className="w-full h-full pointer-events-none">
                                                <TemplateSvg id={item.content} />
                                            </div>
                                        )}

                                        {isSelected && !isLocked && (
                                            <div
                                                className="absolute -bottom-4 -right-4 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-2 cursor-nwse-resize z-50 shadow-lg"
                                                onPointerDown={(e) => handleItemResizeStart(e, item.id)}
                                                title="„Åä„Åä„Åç„ÅïÂ§âÊõ¥"
                                            >
                                                <ArrowDownRight size={18} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="absolute top-1/2 -translate-y-1/2 left-4 bg-white/90 backdrop-blur shadow-2xl rounded-2xl p-3 flex flex-col gap-4 z-50 border border-slate-200" style={{ maxHeight: '90vh', overflowY: 'auto' }}>
                        {/* Êàª„ÇãÔºàUndoÔºâ„Éú„Çø„É≥ */}
                        <button onClick={undo} disabled={!canUndo} className={`flex flex-col items-center gap-1 p-3 rounded-xl transition-colors group ${canUndo ? 'hover:bg-orange-50 cursor-pointer' : 'opacity-50 cursor-not-allowed'}`}>
                            <div className="bg-orange-100 p-2 rounded-lg group-hover:scale-110 transition-transform flex items-center justify-center font-bold text-xl text-orange-600" style={{ width: '44px', height: '44px' }}>‚Ü∫</div>
                            <span className="text-xs font-bold text-slate-600">„ÇÇ„Å©„Çã</span>
                        </button>
                        <div className="h-px bg-slate-200 my-1 w-full"></div>

                        {/* „ÉÑ„Éº„É´„É¢„Éº„ÉâÂàáÊõø */}
                        <div className="flex bg-slate-100 rounded-xl p-1 gap-1">
                            <button onClick={() => setToolMode('select')} title="„Åõ„Çì„Åü„Åè" className={`p-2 rounded-lg transition-transform ${toolMode === 'select' ? 'bg-cyan-200 text-cyan-800 scale-110 shadow-sm' : 'hover:bg-cyan-100 text-slate-500'}`}>
                                <MousePointer2 size={24} />
                            </button>
                            <button onClick={() => setToolMode('pan')} title="„Å™„Åß„Çã" className={`p-2 rounded-lg transition-transform ${toolMode === 'pan' ? 'bg-cyan-200 text-cyan-800 scale-110 shadow-sm' : 'hover:bg-cyan-100 text-slate-500'}`}>
                                <Hand size={24} />
                            </button>
                            <button onClick={() => setToolMode('draw')} title="„Éö„É≥" className={`p-2 rounded-lg transition-transform ${toolMode === 'draw' ? 'bg-cyan-200 text-cyan-800 scale-110 shadow-sm' : 'hover:bg-cyan-100 text-slate-500'}`}>
                                <PenLine size={24} />
                            </button>
                            <button onClick={() => setToolMode('eraser')} title="Ê∂à„Åó„Ç¥„É†" className={`p-2 rounded-lg transition-transform ${toolMode === 'eraser' ? 'bg-cyan-200 text-cyan-800 scale-110 shadow-sm' : 'hover:bg-cyan-100 text-slate-500'}`}>
                                <Eraser size={24} />
                            </button>
                        </div>

                        {/* „Éö„É≥„ÅÆËâ≤ÈÅ∏ÊäûÔºà„Éö„É≥„É¢„Éº„ÉâÊôÇ„ÅÆ„ÅøÔºâ */}
                        {toolMode === 'draw' && (
                            <div className="flex gap-2 justify-center p-2 bg-slate-50 rounded-xl">
                                {['#ef4444', '#3b82f6', '#22c55e', '#eab308', '#000000'].map(c => (
                                    <button
                                        key={c}
                                        onClick={() => setDrawColor(c)}
                                        className={`w-6 h-6 rounded-full border shadow-sm transition-transform hover:scale-110 ${drawColor === c ? 'scale-125 ring-2 ring-offset-1 ring-slate-400 border-slate-800' : 'border-slate-300'}`}
                                        style={{ backgroundColor: c }}
                                    />
                                ))}
                            </div>
                        )}

                        <div className="h-px bg-slate-200 my-1 w-full"></div>

                        <button onClick={addSticky} className="flex flex-col items-center gap-1 p-3 hover:bg-yellow-50 rounded-xl transition-colors group">
                            <div className="bg-yellow-100 p-2 rounded-lg group-hover:scale-110 transition-transform"><StickyNote className="text-yellow-600" size={28} /></div>
                            <span className="text-xs font-bold text-slate-600">„Åµ„Åõ„Çì</span>
                        </button>
                        <button onClick={addText} className="flex flex-col items-center gap-1 p-3 hover:bg-blue-50 rounded-xl transition-colors group">
                            <div className="bg-blue-100 p-2 rounded-lg group-hover:scale-110 transition-transform"><Type className="text-blue-600" size={28} /></div>
                            <span className="text-xs font-bold text-slate-600">ÊñáÂ≠ó</span>
                        </button>
                        <button onClick={() => fileInputRef.current?.click()} className="flex flex-col items-center gap-1 p-3 hover:bg-green-50 rounded-xl transition-colors group">
                            <div className="bg-green-100 p-2 rounded-lg group-hover:scale-110 transition-transform"><ImageIcon className="text-green-600" size={28} /></div>
                            <span className="text-xs font-bold text-slate-600">ÁîªÂÉè</span>
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} />
                        </button>
                        <div className="h-px bg-slate-200 my-1 w-full"></div>
                        <button onClick={() => setShowTemplateModal(true)} className="flex flex-col items-center gap-1 p-3 hover:bg-purple-50 rounded-xl transition-colors group">
                            <div className="bg-purple-100 p-2 rounded-lg group-hover:scale-110 transition-transform"><LayoutTemplate className="text-purple-600" size={28} /></div>
                            <span className="text-xs font-bold text-slate-600">„ÉÜ„É≥„Éó„É¨„Éº„Éà</span>
                        </button>

                        <div className="h-px bg-slate-200 my-1 w-full"></div>

                        <button onClick={() => setShowTutorialModal(true)} className="flex flex-col items-center gap-1 p-3 bg-indigo-50 hover:bg-indigo-100 rounded-xl transition-colors group shadow-sm border border-indigo-200">
                            <div className="bg-indigo-100 p-2 rounded-lg group-hover:scale-110 transition-transform"><HelpCircle className="text-indigo-600" size={28} /></div>
                            <span className="text-[10px] font-bold text-indigo-700">ÊÄùËÄÉ„ÉÑ„Éº„É´„ÅÆ</span>
                            <span className="text-[10px] font-bold text-indigo-700">Ë™¨Êòé</span>
                        </button>

                        <button onClick={deleteAll} className="flex flex-col items-center gap-1 p-3 hover:bg-red-50 rounded-xl transition-colors group">
                            <div className="bg-red-100 p-2 rounded-lg group-hover:scale-110 transition-transform"><Eraser className="text-red-500" size={28} /></div>
                            <span className="text-xs font-bold text-red-600">„Åô„Åπ„Å¶ÂâäÈô§</span>
                        </button>

                        <div className="mt-2 flex flex-col items-center gap-1">
                            {/* „Ç¢„Éó„É™‰∏ÄË¶ß„Å´Êàª„Çã„É™„É≥„ÇØ„Å´Â§âÊõ¥ */}
                            <a href="../index.html" className="text-center font-bold text-sm text-slate-500 hover:text-slate-800 transition-colors bg-slate-200 px-3 py-2 rounded-lg">‰∏ÄË¶ß„Å∏</a>
                        </div>
                    </div>

                    <div className="absolute bottom-6 right-6 flex bg-white/90 backdrop-blur shadow-xl rounded-full p-2 gap-2 z-50 border border-slate-200">
                        <button onClick={() => setView(v => ({ ...v, scale: Math.min(5, v.scale * 1.2) }))} className="p-3 hover:bg-slate-100 rounded-full transition-colors text-slate-600" title="„Ç∫„Éº„É†„Ç§„É≥">
                            <ZoomIn size={24} />
                        </button>
                        <div className="flex items-center justify-center w-16 font-extrabold text-slate-700 text-sm">
                            {Math.round(view.scale * 100)}%
                        </div>
                        <button onClick={() => setView(v => ({ ...v, scale: Math.max(0.1, v.scale / 1.2) }))} className="p-3 hover:bg-slate-100 rounded-full transition-colors text-slate-600" title="„Ç∫„Éº„É†„Ç¢„Ç¶„Éà">
                            <ZoomOut size={24} />
                        </button>
                        <div className="w-px bg-slate-200 my-2"></div>
                        <button onClick={() => setView({ x: 0, y: 0, scale: 1 })} className="p-3 hover:bg-slate-100 rounded-full transition-colors text-slate-600" title="ÊúÄÂàù„ÅÆ‰ΩçÁΩÆ„Å´„ÇÇ„Å©„Çã">
                            <Focus size={24} />
                        </button>
                    </div>

                    {
                        showTemplateModal && (
                            <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                                <div className="bg-white p-6 md:p-8 rounded-3xl w-full max-w-5xl max-h-[90vh] flex flex-col shadow-2xl transform transition-all">
                                    <h2 className="text-2xl md:text-3xl font-extrabold text-slate-800 mb-6 text-center">„Å§„Åã„ÅÑ„Åü„ÅÑ„ÄåÊÄùËÄÉ„ÉÑ„Éº„É´„Äç„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ</h2>
                                    <div className="overflow-y-auto flex-1 pr-2 custom-scrollbar">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {TEMPLATES.map(t => (
                                                <button
                                                    key={t.id}
                                                    onClick={() => addTemplate(t.id)}
                                                    className="border-4 border-slate-100 rounded-2xl p-4 hover:border-purple-400 hover:bg-purple-50 hover:-translate-y-1 transition-all flex flex-col items-center gap-4 group"
                                                >
                                                    <div className="w-full h-32 bg-slate-50 rounded-xl flex items-center justify-center pointer-events-none p-2 relative overflow-hidden">
                                                        <TemplateSvg id={t.id} />
                                                        <div className="absolute inset-0 bg-transparent group-hover:bg-purple-500/10 transition-colors"></div>
                                                    </div>
                                                    <span className="font-extrabold text-slate-700 text-lg">{t.name}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="mt-8 flex justify-center">
                                        <button
                                            onClick={() => setShowTemplateModal(false)}
                                            className="px-10 py-4 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-full font-bold text-lg transition-colors shadow-sm"
                                        >
                                            „ÇÑ„ÇÅ„Çã („Å®„Åò„Çã)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {/* „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´Áî®„É¢„Éº„ÉÄ„É´ */}
                    {
                        showTutorialModal && (
                            <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                                <div className="bg-white p-6 md:p-8 rounded-3xl w-full max-w-5xl max-h-[90vh] flex flex-col shadow-2xl transform transition-all">
                                    <h2 className="text-2xl md:text-3xl font-extrabold text-slate-800 mb-6 text-center">ÊÄùËÄÉ„ÉÑ„Éº„É´„ÅÆ‰Ωø„ÅÑÊñπ„ÉªÂÖ∑‰Ωì‰æã</h2>
                                    <div className="overflow-y-auto flex-1 pr-2 custom-scrollbar">
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                            <button onClick={() => setTutorialImage('images/xtya-to.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">X„ÉÅ„É£„Éº„Éà</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/ytya-to.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">Y„ÉÅ„É£„Éº„Éà</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/zahyoujiku.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">Â∫ßÊ®ôËª∏</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/bennzu.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">„Éô„É≥Âõ≥</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/pmitya-to.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">PMI„ÉÅ„É£„Éº„Éà</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/kwltya-to.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">KWL„ÉÅ„É£„Éº„Éà</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/kuragetya-to.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">„ÇØ„É©„Ç≤„ÉÅ„É£„Éº„Éà</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/fissyubo-nnzu.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">„Éï„Ç£„ÉÉ„Ç∑„É•„Éú„Éº„É≥Âõ≥</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/kyandhitya-to.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">„Ç≠„É£„É≥„Éá„Ç£„Éº„ÉÅ„É£„Éº„Éà</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/piramiddotya-to.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">„Éî„É©„Éü„ÉÉ„Éâ„ÉÅ„É£„Éº„Éà</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/ime-jimappu.png?v=2')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">„Ç§„É°„Éº„Ç∏„Éû„ÉÉ„Éó</div>
                                            </button>
                                            <button onClick={() => setTutorialImage('images/sutepputya-to.png')} className="border-2 border-indigo-100 rounded-xl p-4 hover:bg-indigo-50 text-left transition-colors">
                                                <div className="font-extrabold text-indigo-800">„Çπ„ÉÜ„ÉÉ„Éó„ÉÅ„É£„Éº„Éà</div>
                                            </button>
                                        </div>
                                    </div>
                                    <div className="mt-8 flex justify-center">
                                        <button onClick={() => setShowTutorialModal(false)} className="px-10 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-full font-bold text-lg">
                                            „ÇÑ„ÇÅ„Çã („Å®„Åò„Çã)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )
                    }

                    {/* „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´ÁîªÂÉè„Éó„É¨„Éì„É•„ÉºÁî®„É¢„Éº„ÉÄ„É´ */}
                    {
                        tutorialImage && (
                            <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center z-[200] p-4" onClick={() => setTutorialImage(null)}>
                                <div className="relative w-full h-full flex items-center justify-center max-w-7xl max-h-[95vh]">
                                    <img src={tutorialImage} alt="ÊÄùËÄÉ„ÉÑ„Éº„É´„ÅÆË™¨Êòé" className="max-w-full max-h-full object-contain shadow-2xl rounded-lg" />
                                    <button
                                        className="absolute top-4 right-4 bg-white/20 hover:bg-white/40 text-white rounded-full p-3 transition-colors backdrop-blur-sm"
                                        onClick={(e) => { e.stopPropagation(); setTutorialImage(null); }}
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>
                                    </button>
                                </div>
                            </div>
                        )
                    }

                    <style>{`
            .custom-scrollbar::-webkit-scrollbar { width: 8px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
          `}</style>
                </div >
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>