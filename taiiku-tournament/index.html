<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½“è‚²ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <!-- Tailwind CSS (ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2196f3;
            --secondary-color: #4caf50;
            --bg-color: #e0f7fa;
        }

        body {
            font-family: 'Noto Sans JP', "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#b2ebf2 10%, transparent 11%),
                radial-gradient(#b2ebf2 10%, transparent 11%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            color: #333;
            overflow-x: hidden;
        }

        /* å°åˆ·æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© */
        @media print {
            body {
                background: white !important;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            .card {
                border: none;
                box-shadow: none;
                background: transparent;
            }

            .tournament-container {
                overflow: visible !important;
            }

            .match {
                break-inside: avoid;
            }
        }

        .print-only {
            display: none;
        }

        input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
        }

        .winner {
            background-color: #fffde7;
            border: 2px solid #ffd600 !important;
            position: relative;
            font-weight: bold;
            color: #d84315;
        }

        .winner::after {
            content: "ğŸ†";
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            animation: bounce-small 1s infinite alternate;
        }

        @keyframes bounce-small {
            from {
                transform: translateY(-50%) scale(1);
            }

            to {
                transform: translateY(-50%) scale(1.2);
            }
        }

        .tournament-bracket {
            min-width: 800px;
            padding: 20px;
        }

        .match {
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: white;
        }

        .match:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .score {
            width: 4.5rem !important;
            height: 2.5rem;
            font-size: 1.25rem;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-weight: bold;
            transition: border-color 0.2s;
        }

        .score:focus {
            border-color: var(--primary-color);
        }

        .bye-match {
            opacity: 0.85;
            background-color: #f8f9fa;
        }

        .repechage {
            background-color: #fff8e1;
            color: #f57c00;
            font-style: italic;
        }

        .editable-player {
            border: 1px dashed #ccc;
            cursor: text;
            transition: all 0.2s;
        }

        .editable-player:focus {
            background-color: white;
            border-style: solid;
            border-color: var(--primary-color);
            outline: none;
        }

        .bye-player {
            background-color: #f0f0f0;
            color: #757575;
        }

        .app-title {
            text-shadow: 2px 2px 0 #ffffff, 4px 4px 0 rgba(0, 0, 0, 0.1);
            color: #ff5722;
            letter-spacing: 2px;
        }

        .round-title {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border-radius: 20px;
            padding: 6px 20px;
            font-weight: bold;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .player-name-container {
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4fc3f7, #2196f3);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a5d6a7, #4caf50);
            color: white;
        }

        .btn-back {
            background: linear-gradient(135deg, #ffcc80, #ff9800);
            color: white;
        }

        .input-container {
            position: relative;
        }

        .input-container::before {
            content: "âœï¸";
            position: absolute;
            left: -24px;
            top: 65%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .input-container:hover::before {
            opacity: 1;
        }

        .card {
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            background-color: rgba(255, 255, 255, 0.98);
            border: 3px solid #81d4fa;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ */
        .timer-container {
            background: linear-gradient(135deg, #64b5f6, #1976d2);
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border: 2px solid #fff;
        }

        .timer-display {
            font-family: monospace;
        }

        .timer-btn {
            transition: transform 0.1s ease;
        }

        .timer-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .timer-end-overlay,
        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }

        .timer-end-overlay {
            background-color: rgba(220, 38, 38, 0.9);
            animation: pulse-bg 1s infinite alternate;
        }

        @keyframes pulse-bg {
            from {
                background-color: rgba(220, 38, 38, 0.85);
            }

            to {
                background-color: rgba(220, 38, 38, 0.95);
            }
        }

        .victory-overlay {
            background: linear-gradient(135deg, #fff176, #ff9800);
            animation: gradient-shift 5s ease infinite;
            background-size: 200% 200%;
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .trophy-animation {
            animation: trophy-bounce 1s infinite alternate cubic-bezier(0.5, 0, 0.5, 1);
        }

        @keyframes trophy-bounce {
            from {
                transform: scale(1) translateY(0);
            }

            to {
                transform: scale(1.15) translateY(-20px);
            }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: confetti-fall linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ */
        .grab-scroll {
            cursor: grab;
            -webkit-overflow-scrolling: touch;
        }

        .grab-scroll:active {
            cursor: grabbing;
        }
    </style>
</head>

<body>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: äººæ•°å…¥åŠ› -->
    <div id="step1" class="container mx-auto p-4 max-w-lg mt-12 fade-in">
        <div class="card p-8 text-center">
            <h1 class="text-4xl font-bold mb-2 app-title">ä½“è‚²ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ<br>ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
            <p class="text-gray-500 mb-8 font-medium">ç°¡å˜ãƒ»ç¶ºéº—ã«å¯¾æˆ¦è¡¨ã‚’ä½œæˆ</p>

            <div class="mb-8 text-left">
                <label class="block text-blue-800 text-lg font-bold mb-3" for="playerCount">
                    ğŸ‘¥ å‚åŠ ãƒãƒ¼ãƒ ãƒ»äººæ•° (4ã€œ41äºº)
                </label>
                <input
                    class="shadow-inner appearance-none border-2 border-blue-200 rounded-xl w-full py-4 px-4 text-gray-700 text-2xl text-center leading-tight focus:outline-none focus:border-blue-500 transition-colors"
                    id="playerCount" type="number" min="4" max="41" value="8" placeholder="ä¾‹: 8">
            </div>
            <button id="nextToStep2" class="btn btn-primary w-full py-4 text-xl rounded-full">
                æ¬¡ã¸é€²ã‚€ â”
            </button>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: åå‰å…¥åŠ› -->
    <div id="step2" class="container mx-auto p-4 max-w-5xl hidden">
        <div class="card p-6 md:p-8">
            <h1 class="text-3xl font-bold text-center mb-2 app-title">å‚åŠ è€…åå…¥åŠ›</h1>
            <p class="text-center text-gray-500 mb-8">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ç©ºç™½ã®å ´åˆã¯è‡ªå‹•ã§ç•ªå·ãŒæŒ¯ã‚‰ã‚Œã¾ã™ã€‚</p>

            <div class="mb-6">
                <div id="playerInputContainer"
                    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹åå‰å…¥åŠ›æ¬„ -->
                </div>
            </div>

            <div
                class="flex flex-col md:flex-row justify-between items-center mt-8 pt-6 border-t border-gray-100 gap-4">
                <button id="backToStep1" class="btn btn-back py-3 px-8 w-full md:w-auto">
                    â† æˆ»ã‚‹
                </button>
                <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                    <button id="randomizeNames" class="btn btn-secondary py-3 px-6">
                        ğŸ”€ ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
                    </button>
                    <button id="generateTournament" class="btn btn-primary py-3 px-8 text-lg">
                        ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ã‚’ä½œæˆ âœ¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨ -->
    <div id="step3" class="container mx-auto p-2 sm:p-4 hidden h-screen flex flex-col">
        <div class="card p-4 sm:p-6 flex-grow flex flex-col mb-4">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 no-print border-b pb-4">
                <h1 class="text-2xl sm:text-3xl font-bold app-title">å¤§ä¼šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</h1>
                <div class="flex space-x-3">
                    <button id="backToStep2" class="btn btn-back py-2 px-5 text-sm sm:text-base">
                        âœ ç·¨é›†ã«æˆ»ã‚‹
                    </button>
                    <button onclick="window.print()"
                        class="btn bg-gray-700 text-white py-2 px-5 hover:bg-gray-800 text-sm sm:text-base">
                        ğŸ–¨ï¸ å°åˆ·
                    </button>
                </div>
            </div>

            <!-- ã‚¿ã‚¤ãƒãƒ¼ (å°åˆ·æ™‚ã¯éè¡¨ç¤º) -->
            <div class="timer-container p-4 mb-6 no-print mx-auto max-w-md w-full">
                <h2 class="text-lg font-bold text-white mb-2 text-center">â±ï¸ è©¦åˆã‚¿ã‚¤ãƒãƒ¼</h2>
                <div class="flex items-center justify-center mb-4">
                    <div class="flex bg-white rounded-xl p-2 shadow-inner">
                        <input type="number" id="timerMinutes" min="0" max="99" value="3"
                            class="w-16 text-center text-4xl font-bold border-0 focus:outline-none text-blue-800 timer-display"
                            placeholder="åˆ†">
                        <span class="text-4xl font-bold mx-1 text-gray-400 pb-1">:</span>
                        <input type="number" id="timerSeconds" min="0" max="59" value="0"
                            class="w-16 text-center text-4xl font-bold border-0 focus:outline-none text-blue-800 timer-display"
                            placeholder="ç§’">
                    </div>
                </div>
                <div class="flex justify-center gap-2 sm:gap-4">
                    <button id="startTimer"
                        class="timer-btn bg-white text-green-600 font-bold py-2 px-6 rounded-full shadow hover:bg-green-50">
                        â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ
                    </button>
                    <button id="pauseTimer"
                        class="timer-btn bg-white text-yellow-600 font-bold py-2 px-4 rounded-full shadow hover:bg-yellow-50"
                        disabled>
                        â¸ åœæ­¢
                    </button>
                    <button id="resetTimer"
                        class="timer-btn bg-white text-red-600 font-bold py-2 px-4 rounded-full shadow hover:bg-red-50"
                        disabled>
                        â†º ãƒªã‚»ãƒƒãƒˆ
                    </button>
                </div>
            </div>

            <!-- å°åˆ·ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="print-only text-center mb-8">
                <h1 class="text-4xl font-bold mb-2">å¤§ä¼šãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨</h1>
                <p id="printPlayerCount" class="text-xl text-gray-600">å‚åŠ : <span></span> ãƒãƒ¼ãƒ /äºº</p>
            </div>

            <!-- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè¡¨æç”»ã‚¨ãƒªã‚¢ (ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ) -->
            <div id="tournamentContainer"
                class="tournament-container overflow-x-auto flex-grow grab-scroll bg-gray-50 rounded-xl p-4 border border-gray-200">
                <!-- JavaScriptã§ã“ã“ã«ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- ã‚¿ã‚¤ãƒãƒ¼çµ‚äº†æ™‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="timerEndOverlay" class="timer-end-overlay hidden fade-in">
        <div class="text-white text-center">
            <div class="text-8xl mb-4">â°</div>
            <h1 class="text-6xl md:text-8xl font-bold mb-6 tracking-wider">TIME UP!</h1>
            <p class="text-2xl bg-black bg-opacity-30 inline-block px-6 py-2 rounded-full">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</p>
        </div>
    </div>

    <!-- å„ªå‹ç”»é¢ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="victoryOverlay" class="victory-overlay hidden fade-in">
        <div class="text-center">
            <div class="trophy-animation text-8xl md:text-9xl mb-8">ğŸ†</div>
            <h1 class="text-5xl md:text-6xl font-bold mb-2 text-yellow-900">å„ªå‹</h1>
            <div class="bg-white px-8 py-4 rounded-2xl shadow-xl my-8 mx-4 border-4 border-yellow-400">
                <h2 id="winnerName" class="text-4xl md:text-6xl font-extrabold text-blue-800">ãƒãƒ¼ãƒ å</h2>
            </div>
            <p class="text-3xl text-yellow-900 font-bold">ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰</p>
            <p class="text-lg mt-12 bg-black bg-opacity-10 inline-block px-6 py-2 rounded-full text-yellow-900">
                ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–‰ã˜ã‚‹</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- è¦ç´ ã®å–å¾— ---
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const playerCountInput = document.getElementById('playerCount');
            const playerInputContainer = document.getElementById('playerInputContainer');
            const printPlayerCountSpan = document.querySelector('#printPlayerCount span');
            const tournamentContainer = document.getElementById('tournamentContainer');

            const timerEndOverlay = document.getElementById('timerEndOverlay');
            const victoryOverlay = document.getElementById('victoryOverlay');
            const winnerNameElement = document.getElementById('winnerName');

            const timerMinutesInput = document.getElementById('timerMinutes');
            const timerSecondsInput = document.getElementById('timerSeconds');
            const startTimerButton = document.getElementById('startTimer');
            const pauseTimerButton = document.getElementById('pauseTimer');
            const resetTimerButton = document.getElementById('resetTimer');

            const nextToStep2Button = document.getElementById('nextToStep2');
            const backToStep1Button = document.getElementById('backToStep1');
            const randomizeNamesButton = document.getElementById('randomizeNames');
            const generateTournamentButton = document.getElementById('generateTournament');
            const backToStep2Button = document.getElementById('backToStep2');

            // --- çŠ¶æ…‹å¤‰æ•° ---
            let playerNames = [];
            let tournamentData = { rounds: [], matches: [] };
            let originalPlayerCount = 0;
            let hasAutomaticBye = false;

            // ã‚¿ã‚¤ãƒãƒ¼ç”¨
            let timerInterval = null;
            let totalSeconds = 0;
            let isTimerRunning = false;

            // ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ç”¨
            let audioCtx = null;
            let alarmInterval = null;

            // --- éŸ³å£°åˆæœŸåŒ–ãƒ»å†ç”Ÿé–¢æ•° ---
            function initAudio() {
                // iPad(Safari)ç­‰ã®åˆ¶ç´„ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã«AudioContextã‚’ä½œæˆãƒ»å†é–‹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            }

            function playBeep() {
                if (!audioCtx) return;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, audioCtx.currentTime); // ãƒ©(A5)ã®éŸ³

                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(1, audioCtx.currentTime + 0.05);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);

                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.3);
            }

            function startAlarm() {
                playBeep(); // æœ€åˆã®1å›
                alarmInterval = setInterval(playBeep, 500); // 0.5ç§’é–“éš”ã§é³´ã‚‰ã—ç¶šã‘ã‚‹
            }

            function stopAlarm() {
                if (alarmInterval) {
                    clearInterval(alarmInterval);
                    alarmInterval = null;
                }
            }

            // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•° ---
            function showStep(stepElement) {
                [step1, step2, step3].forEach(el => el.classList.add('hidden', 'fade-in'));
                stepElement.classList.remove('hidden');
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã®ãƒãƒƒã‚¯
                void stepElement.offsetWidth;
            }

            // --- ãƒ‰ãƒ©ãƒƒã‚°ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ ---
            let isDown = false;
            let startX;
            let scrollLeft;

            tournamentContainer.addEventListener('mousedown', (e) => {
                // å…¥åŠ›æ¬„ã‚„ã‚«ãƒ¼ãƒ‰ä¸Šã§ã®ã‚¯ãƒªãƒƒã‚¯ã¯ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ãªã„
                if (e.target.tagName === 'INPUT' || e.target.isContentEditable || e.target.closest('.match')) return;
                isDown = true;
                tournamentContainer.classList.add('active');
                startX = e.pageX - tournamentContainer.offsetLeft;
                scrollLeft = tournamentContainer.scrollLeft;
            });
            tournamentContainer.addEventListener('mouseleave', () => { isDown = false; });
            tournamentContainer.addEventListener('mouseup', () => { isDown = false; });
            tournamentContainer.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - tournamentContainer.offsetLeft;
                const walk = (x - startX) * 2; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦
                tournamentContainer.scrollLeft = scrollLeft - walk;
            });

            // --- ã‚¿ã‚¤ãƒãƒ¼å‡¦ç† ---
            const formatTime = (val) => val.toString().padStart(2, '0');

            [timerMinutesInput, timerSecondsInput].forEach(input => {
                input.addEventListener('input', function () {
                    let max = this.id === 'timerMinutes' ? 99 : 59;
                    let val = parseInt(this.value);
                    if (isNaN(val) || val < 0) this.value = 0;
                    else if (val > max) this.value = max;
                });
                input.addEventListener('blur', function () {
                    if (this.value === '') this.value = '00';
                    else this.value = formatTime(this.value);
                });
            });

            startTimerButton.addEventListener('click', function () {
                initAudio(); // éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ã®æº–å‚™ï¼ˆã‚¿ãƒƒãƒ—æ™‚å¿…é ˆï¼‰

                if (!isTimerRunning) {
                    const minutes = parseInt(timerMinutesInput.value) || 0;
                    const seconds = parseInt(timerSecondsInput.value) || 0;
                    totalSeconds = minutes * 60 + seconds;

                    if (totalSeconds <= 0) return;

                    isTimerRunning = true;
                    startTimerButton.disabled = true;
                    pauseTimerButton.disabled = false;
                    resetTimerButton.disabled = false;
                    timerMinutesInput.disabled = true;
                    timerSecondsInput.disabled = true;

                    timerInterval = setInterval(updateTimer, 1000);
                }
            });

            pauseTimerButton.addEventListener('click', function () {
                if (isTimerRunning) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    startTimerButton.disabled = false;
                    startTimerButton.innerHTML = 'â–¶ å†é–‹';
                }
            });

            resetTimerButton.addEventListener('click', function () {
                clearInterval(timerInterval);
                isTimerRunning = false;
                startTimerButton.disabled = false;
                pauseTimerButton.disabled = true;
                resetTimerButton.disabled = true;
                timerMinutesInput.disabled = false;
                timerSecondsInput.disabled = false;
                startTimerButton.innerHTML = 'â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ';
                timerMinutesInput.value = '03';
                timerSecondsInput.value = '00';
            });

            function updateTimer() {
                if (totalSeconds <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    startAlarm(); // æ™‚é–“åˆ‡ã‚Œã§ã‚¢ãƒ©ãƒ¼ãƒ é–‹å§‹
                    timerEndOverlay.classList.remove('hidden');
                    resetTimerButton.click();
                    return;
                }
                totalSeconds--;
                timerMinutesInput.value = formatTime(Math.floor(totalSeconds / 60));
                timerSecondsInput.value = formatTime(totalSeconds % 60);
            }

            timerEndOverlay.addEventListener('click', function () {
                this.classList.add('hidden');
                stopAlarm(); // ç”»é¢ã‚¿ãƒƒãƒ—ã§éŸ³ã‚’æ­¢ã‚ã‚‹
            });
            victoryOverlay.addEventListener('click', function () { this.classList.add('hidden'); });

            // --- ã‚¹ãƒ†ãƒƒãƒ—1 -> 2 ---
            nextToStep2Button.addEventListener('click', function () {
                const count = parseInt(playerCountInput.value);
                if (isNaN(count) || count < 4 || count > 41) {
                    alert('å‚åŠ äººæ•°ã¯ 4ã€œ41äºº ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                originalPlayerCount = count;
                hasAutomaticBye = count % 2 !== 0;
                createPlayerInputs();
            });

            function createPlayerInputs() {
                playerInputContainer.innerHTML = '';
                for (let i = 1; i <= originalPlayerCount; i++) {
                    const div = document.createElement('div');
                    div.className = 'input-container';
                    div.innerHTML = `
                    <label class="block text-blue-700 text-sm font-bold mb-1 pl-1" for="player${i}">No. ${i}</label>
                    <input type="text" id="player${i}" class="player-name shadow-sm appearance-none border-2 border-gray-200 rounded-lg w-full py-2.5 px-3 text-gray-700 leading-tight focus:outline-none focus:border-blue-500 bg-white" placeholder="é¸æ‰‹ / ãƒãƒ¼ãƒ å" value="ãƒãƒ¼ãƒ ${i}">
                `;
                    playerInputContainer.appendChild(div);
                }
                if (hasAutomaticBye) {
                    const div = document.createElement('div');
                    div.className = 'input-container opacity-80';
                    div.innerHTML = `
                    <label class="block text-gray-500 text-sm font-bold mb-1 pl-1" for="playerBye">è‡ªå‹•èª¿æ•´æ </label>
                    <input type="text" id="playerBye" class="player-name shadow-sm appearance-none border-2 border-gray-200 rounded-lg w-full py-2.5 px-3 text-gray-500 leading-tight bg-gray-100 bye-player" value="ä¸æˆ¦å‹" readonly>
                `;
                    playerInputContainer.appendChild(div);
                }
                showStep(step2);
            }

            // --- ã‚¹ãƒ†ãƒƒãƒ—2 -> 1 ---
            backToStep1Button.addEventListener('click', () => showStep(step1));

            // --- ãƒ©ãƒ³ãƒ€ãƒ é…ç½® ---
            randomizeNamesButton.addEventListener('click', function () {
                const allInputs = Array.from(document.querySelectorAll('.player-name')).map(input => ({
                    value: input.value,
                    isBye: input.classList.contains('bye-player')
                }));

                // Fisher-Yates ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                for (let i = allInputs.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allInputs[i], allInputs[j]] = [allInputs[j], allInputs[i]];
                }

                const inputs = document.querySelectorAll('.player-name');
                inputs.forEach((input, index) => {
                    input.value = allInputs[index].value;
                    if (allInputs[index].isBye) {
                        input.classList.add('bye-player', 'bg-gray-100', 'text-gray-500');
                        input.readOnly = true;
                    } else {
                        input.classList.remove('bye-player', 'bg-gray-100', 'text-gray-500');
                        input.readOnly = false;
                    }
                });
            });

            // --- ã‚¹ãƒ†ãƒƒãƒ—2 -> 3 (ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆç”Ÿæˆ) ---
            generateTournamentButton.addEventListener('click', function () {
                playerNames = Array.from(document.querySelectorAll('.player-name')).map((input, idx) => {
                    return input.value.trim() || `ãƒãƒ¼ãƒ ${idx + 1}`;
                });

                calculateTournamentStructure(playerNames.length);
                generateTournamentBracket();

                printPlayerCountSpan.textContent = originalPlayerCount;
                showStep(step3);
            });

            // --- ã‚¹ãƒ†ãƒƒãƒ—3 -> 2 (æˆ»ã‚‹) ---
            backToStep2Button.addEventListener('click', function () {
                if (isTimerRunning) resetTimerButton.click();
                showStep(step2);
            });

            // --- ãƒ‡ãƒ¼ã‚¿æ§‹é€ è¨ˆç®— ---
            function calculateTournamentStructure(playerCount) {
                const totalRounds = Math.ceil(Math.log2(playerCount));
                tournamentData = { rounds: [], matches: [] };

                for (let round = 1; round <= totalRounds; round++) {
                    let roundName = round === totalRounds ? 'æ±ºå‹' :
                        round === totalRounds - 1 ? 'æº–æ±ºå‹' :
                            round === totalRounds - 2 ? 'æº–ã€…æ±ºå‹' : `${round}å›æˆ¦`;

                    let matchesInRound = round === 1 ? Math.ceil(playerCount / 2) :
                        Math.ceil(tournamentData.rounds[round - 2].matches / 2);

                    tournamentData.rounds.push({ round, name: roundName, matches: matchesInRound });
                }

                let byeIndex = playerNames.findIndex(n => n === 'ä¸æˆ¦å‹');

                // 1å›æˆ¦
                for (let i = 0; i < playerNames.length; i += 2) {
                    const matchIdx = i / 2;
                    const match = {
                        id: `match-1-${matchIdx}`, round: 1, matchIndex: matchIdx,
                        nextMatchId: `match-2-${Math.floor(matchIdx / 2)}`,
                        player1: { name: playerNames[i], index: i },
                        player2: i + 1 < playerNames.length ? { name: playerNames[i + 1], index: i + 1 } : null,
                        isBye: false
                    };

                    if (match.player2) {
                        if (i === byeIndex || i + 1 === byeIndex) {
                            match.isBye = true;
                            match.byeWinner = i === byeIndex ? 2 : 1;
                        }
                    } else {
                        // å¥‡æ•°ãƒãƒ¼ãƒ æ•°ã®é˜²å¾¡å‡¦ç†
                        match.player2 = { name: "ä¸æˆ¦å‹", index: -1 };
                        match.isBye = true; match.byeWinner = 1;
                    }
                    tournamentData.matches.push(match);
                }

                // 2å›æˆ¦ä»¥é™
                for (let round = 2; round <= totalRounds; round++) {
                    const matchesInRound = tournamentData.rounds[round - 1].matches;
                    for (let i = 0; i < matchesInRound; i++) {
                        let needsRepechage = false;
                        if (round === 2) {
                            const prevMatches = tournamentData.matches.filter(m => m.round === 1 && Math.floor(m.matchIndex / 2) === i);
                            if (prevMatches.length === 1) needsRepechage = true;
                        }

                        tournamentData.matches.push({
                            id: `match-${round}-${i}`, round, matchIndex: i,
                            player1: { name: '', index: -1 }, player2: { name: '', index: -1 },
                            nextMatchId: round < totalRounds ? `match-${round + 1}-${Math.floor(i / 2)}` : null,
                            needsRepechage, isFinal: round === totalRounds
                        });
                    }
                }
            }

            // --- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆæç”» ---
            function generateTournamentBracket() {
                tournamentContainer.innerHTML = '';
                const bracketContainer = document.createElement('div');
                bracketContainer.className = 'tournament-bracket flex relative items-start';

                tournamentData.rounds.forEach((round, i) => {
                    const roundDiv = document.createElement('div');
                    roundDiv.className = 'px-4 flex-shrink-0 flex flex-col';
                    roundDiv.style.width = '260px';

                    // ãƒ©ã‚¦ãƒ³ãƒ‰å
                    const roundNameDiv = document.createElement('div');
                    roundNameDiv.className = 'text-center mb-6 sticky top-0 bg-gray-50 py-2 z-10';
                    roundNameDiv.innerHTML = `<span class="round-title">${round.name}</span>`;
                    roundDiv.appendChild(roundNameDiv);

                    const matchesContainer = document.createElement('div');
                    matchesContainer.className = 'flex flex-col flex-grow justify-around';

                    const roundMatches = tournamentData.matches.filter(m => m.round === round.round);
                    const isFinal = round.name === 'æ±ºå‹';
                    const spacing = Math.pow(2, i);

                    if (i > 0) matchesContainer.style.paddingTop = `${spacing * 1.5}rem`;

                    roundMatches.forEach((match, j) => {
                        const matchDiv = document.createElement('div');

                        const borderColors = ['border-blue-300', 'border-green-300', 'border-purple-300', 'border-pink-300'];
                        const colorIndex = (i + j) % borderColors.length;
                        let baseClass = `match relative border-2 rounded-xl p-3 ${match.isBye ? 'bye-match' : ''}`;
                        matchDiv.className = isFinal ? `${baseClass} border-yellow-400 bg-yellow-50` : `${baseClass} ${borderColors[colorIndex]}`;

                        matchDiv.id = match.id;
                        matchDiv.dataset.nextMatchId = match.nextMatchId || '';
                        matchDiv.dataset.isFinal = match.isFinal;
                        matchDiv.dataset.matchIndex = match.matchIndex;

                        if (j > 0) matchDiv.style.marginTop = `${spacing * 3}rem`;

                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1
                        matchDiv.appendChild(createPlayerDOM(match.player1, match.isBye && match.byeWinner === 1));

                        // ä¸­é–“ç·š (UIãƒ‡ã‚¶ã‚¤ãƒ³ç”¨)
                        const divider = document.createElement('div');
                        divider.className = 'h-px bg-gray-200 my-2';
                        matchDiv.appendChild(divider);

                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2
                        if (match.needsRepechage) {
                            const p2Div = document.createElement('div');
                            p2Div.className = 'flex justify-between items-center';
                            p2Div.innerHTML = `
                            <div class="player-name-container flex-grow px-3 py-2 text-sm mr-2 repechage editable-player bg-white" contenteditable="true">æ•—è€…å¾©æ´»æ </div>
                            <input type="number" class="score shadow-inner" min="0" placeholder="-" data-player-index="-2">
                        `;
                            matchDiv.appendChild(p2Div);
                        } else {
                            matchDiv.appendChild(createPlayerDOM(match.player2, match.isBye && match.byeWinner === 2));
                        }

                        matchesContainer.appendChild(matchDiv);
                    });

                    roundDiv.appendChild(matchesContainer);
                    bracketContainer.appendChild(roundDiv);
                });

                tournamentContainer.appendChild(bracketContainer);

                // ã‚¹ã‚³ã‚¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚¤ãƒ³ãƒ‰
                document.querySelectorAll('.score').forEach(input => {
                    input.addEventListener('input', handleScoreInput);
                });

                // æ•—è€…å¾©æ´»æ ã®ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰
                document.querySelectorAll('.editable-player').forEach(el => {
                    el.addEventListener('focus', function () { if (this.textContent === 'æ•—è€…å¾©æ´»æ ') this.textContent = ''; });
                    el.addEventListener('blur', function () { if (this.textContent.trim() === '') this.textContent = 'æ•—è€…å¾©æ´»æ '; });
                });

                // ä¸æˆ¦å‹ã®è‡ªå‹•åæ˜ 
                setTimeout(processByes, 300);
            }

            function createPlayerDOM(player, isByeWinner) {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center';
                const nameClass = `player-name-container flex-grow px-3 py-2 text-sm mr-2 bg-white ${isByeWinner ? 'winner' : ''} ${player.name === 'ä¸æˆ¦å‹' ? 'text-gray-400' : ''}`;
                div.innerHTML = `
                <div class="${nameClass}">${player.name || ''}</div>
                <input type="number" class="score shadow-inner" min="0" placeholder="-" data-player-index="${player.index}" ${player.name === 'ä¸æˆ¦å‹' ? 'disabled' : ''}>
            `;
                return div;
            }

            // ä¸æˆ¦å‹æ ã‚’æ¬¡ã®è©¦åˆã¸é€²ã‚ã‚‹å‡¦ç†
            function processByes() {
                const byeMatches = tournamentData.matches.filter(m => m.isBye);
                byeMatches.forEach(match => {
                    if (match.nextMatchId) {
                        const winnerName = match.byeWinner === 1 ? match.player1.name : match.player2.name;
                        const winnerIdx = match.byeWinner === 1 ? match.player1.index : match.player2.index;
                        advanceWinner(match.nextMatchId, match.matchIndex, winnerName, winnerIdx);
                    }
                });
            }

            // --- ã‚¹ã‚³ã‚¢å…¥åŠ›ãƒ»å‹æ•—åˆ¤å®š ---
            function handleScoreInput(e) {
                const matchDiv = e.target.closest('.match');
                if (matchDiv.classList.contains('bye-match')) return; // ä¸æˆ¦å‹ã¯æ‰‹å‹•åˆ¤å®šã—ãªã„

                const scores = matchDiv.querySelectorAll('.score');
                const players = matchDiv.querySelectorAll('.player-name-container');
                const val1 = scores[0].value, val2 = scores[1].value;

                // ã‚¹ã‚³ã‚¢ãŒæ¶ˆã•ã‚ŒãŸå ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
                if (val1 === '' || val2 === '') {
                    players[0].classList.remove('winner');
                    players[1].classList.remove('winner');
                    return;
                }

                const s1 = parseInt(val1), s2 = parseInt(val2);
                let winnerName = null, winnerIdx = null;

                if (s1 > s2) {
                    winnerName = players[0].textContent; winnerIdx = scores[0].dataset.playerIndex;
                    players[0].classList.add('winner'); players[1].classList.remove('winner');
                } else if (s2 > s1) {
                    winnerName = players[1].textContent; winnerIdx = scores[1].dataset.playerIndex;
                    players[1].classList.add('winner'); players[0].classList.remove('winner');
                } else {
                    // å¼•ãåˆ†ã‘ã¯å‡¦ç†ã—ãªã„
                    players[0].classList.remove('winner'); players[1].classList.remove('winner');
                    return;
                }

                if (matchDiv.dataset.isFinal === 'true') {
                    showVictory(winnerName);
                } else if (matchDiv.dataset.nextMatchId) {
                    advanceWinner(matchDiv.dataset.nextMatchId, matchDiv.dataset.matchIndex, winnerName, winnerIdx);
                }
            }

            function advanceWinner(nextMatchId, currentMatchIndex, winnerName, winnerIdx) {
                const nextMatch = document.getElementById(nextMatchId);
                if (!nextMatch) return;
                // å¶æ•°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä¸Šã®æ ã€å¥‡æ•°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä¸‹ã®æ 
                const pos = currentMatchIndex % 2 === 0 ? 0 : 1;
                const nextPlayerUI = nextMatch.querySelectorAll('.player-name-container')[pos];
                const nextScoreUI = nextMatch.querySelectorAll('.score')[pos];

                nextPlayerUI.textContent = winnerName;
                nextScoreUI.dataset.playerIndex = winnerIdx;

                // é€²å‡ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                nextPlayerUI.animate([
                    { backgroundColor: '#fff' },
                    { backgroundColor: '#e3f2fd' },
                    { backgroundColor: '#fff' }
                ], { duration: 1000 });
            }

            // --- å„ªå‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ---
            function showVictory(name) {
                winnerNameElement.textContent = name;
                setTimeout(() => {
                    victoryOverlay.classList.remove('hidden');
                    createConfetti(victoryOverlay, 100);
                }, 600);
            }

            function createConfetti(container, count) {
                // æ—¢å­˜ã®ç´™å¹é›ªã‚’ã‚¯ãƒªã‚¢
                container.querySelectorAll('.confetti').forEach(e => e.remove());
                const colors = ['#f44336', '#2196f3', '#ffeb3b', '#4caf50', '#9c27b0', '#ff9800'];
                for (let i = 0; i < count; i++) {
                    const conf = document.createElement('div');
                    conf.className = 'confetti';
                    conf.style.left = `${Math.random() * 100}%`;
                    conf.style.width = `${Math.random() * 10 + 5}px`;
                    conf.style.height = `${Math.random() * 8 + 4}px`;
                    conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    conf.style.animationDuration = `${Math.random() * 3 + 2}s`;
                    conf.style.animationDelay = `${Math.random() * 2}s`;
                    container.appendChild(conf);
                }
            }
        });
    </script>
</body>

</html>