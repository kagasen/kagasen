<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ΩìËÇ≤ÊéàÊ•≠Áî® ‰ΩúÊà¶„Éú„Éº„Éâ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f3f4f6;
            touch-action: none; /* „Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢ */
            user-select: none; /* „ÉÜ„Ç≠„Çπ„ÉàÈÅ∏ÊäûÈò≤Ê≠¢ */
        }
        .tool-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .sheet-tab.active {
            background-color: #3b82f6;
            color: white;
        }
        .court-line {
            fill: none;
            stroke: white;
            stroke-width: 2;
        }
        .court-circle {
            fill: none;
            stroke: white;
            stroke-width: 2;
        }
        .court-area {
            fill: none;
            stroke: white;
            stroke-width: 2;
        }
        .three-point-area {
            fill: #d97706; /* Amber-600 */
            opacity: 0.3;
        }
        .key-area {
            fill: #b45309; /* Amber-700 */
            opacity: 0.4;
        }
        .court-backboard {
            fill: white;
        }
        .court-rim {
            fill: none;
            stroke: #ef4444;
            stroke-width: 2;
        }
        .court-net {
            fill: none;
            stroke: white;
            stroke-width: 1;
        }
        .player {
            cursor: grab;
            transition: transform 0.1s;
        }
        .player:active {
            cursor: grabbing;
            transform: scale(1.1);
        }
        .player.selected div {
            box-shadow: 0 0 0 4px #fbbf24; /* ÈªÑËâ≤„ÅÆÊû†Á∑ö */
            z-index: 50;
        }
        .player-number {
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
        }
        /* ÈªÑËâ≤„ÉÅ„Éº„É†Áî®„ÅÆ„ÉÜ„Ç≠„Çπ„ÉàËâ≤Ë™øÊï¥ */
        .player[data-type="yellow"] .player-number {
            color: #1f2937; /* Gray-800 */
        }
        .ball-emoji {
            font-size: 2rem;
            pointer-events: none;
            user-select: none;
        }
        .drawing-board {
            cursor: crosshair;
        }
        .soccer-goal {
            fill: none;
            stroke: white;
            stroke-width: 2;
        }
        .soccer-net {
            stroke: white;
            stroke-width: 1;
            opacity: 0.5;
        }
        .menu-button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .player-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            overflow: hidden;
            min-width: 150px;
        }
        .arrow-preview, .line-preview {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }
        .animation-target {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px dashed #ef4444;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 100;
        }
        /* „Åù„ÅÆ‰ªñ„Ç≥„Éº„Éà„ÅÆ„Çπ„Çø„Ç§„É´ */
        .other-court-rect {
            fill: white;
            stroke: #333;
            stroke-width: 3;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <div class="container mx-auto p-2 flex-grow flex flex-col h-full">
        <!-- „ÉÑ„Éº„É´„Éê„ÉºÔºö„Ç≥„Éº„ÉàÈÅ∏Êäû -->
        <div class="mb-2 flex flex-wrap gap-2 justify-center">
            <button id="basketballBtn" class="tool-button bg-white px-3 py-1 text-sm md:text-base rounded-lg shadow hover:shadow-md active">
                üèÄ „Éê„Çπ„Ç±
            </button>
            <button id="soccerBtn" class="tool-button bg-white px-3 py-1 text-sm md:text-base rounded-lg shadow hover:shadow-md">
                ‚öΩ „Çµ„ÉÉ„Ç´„Éº
            </button>
            <button id="baseballBtn" class="tool-button bg-white px-3 py-1 text-sm md:text-base rounded-lg shadow hover:shadow-md">
                ‚öæ ÈáéÁêÉ
            </button>
            <button id="dodgeballBtn" class="tool-button bg-white px-3 py-1 text-sm md:text-base rounded-lg shadow hover:shadow-md">
                üî¥ „Éâ„ÉÉ„Ç∏
            </button>
            <button id="volleyballBtn" class="tool-button bg-white px-3 py-1 text-sm md:text-base rounded-lg shadow hover:shadow-md">
                üèê „Éê„É¨„Éº
            </button>
            <button id="otherBtn" class="tool-button bg-white px-3 py-1 text-sm md:text-base rounded-lg shadow hover:shadow-md">
                ‚¨ú „Åù„ÅÆ‰ªñ
            </button>
        </div>

        <!-- „Ç∑„Éº„Éà„Çø„Éñ -->
        <div class="mb-2 flex flex-wrap gap-2 justify-center overflow-x-auto" id="sheetTabsContainer">
            <button class="sheet-tab bg-white px-3 py-1 rounded-lg shadow hover:shadow-md active" data-sheet-id="sheet-1">
                „Ç∑„Éº„Éà1
            </button>
            <button class="sheet-tab bg-green-500 text-white px-3 py-1 rounded-lg shadow hover:shadow-md" id="addSheetBtn">
                Ôºã Êñ∞Ë¶è„Ç∑„Éº„Éà
            </button>
        </div>

        <!-- ‰ΩúÊà¶ÂêçÂÖ•Âäõ -->
        <div class="mb-2 flex justify-center">
            <div class="relative w-full max-w-md">
                <input type="text" id="strategyName" placeholder="‰ΩúÊà¶Âêç„ÇíÂÖ•Âäõ" class="w-full px-4 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <!-- ÊèèÁîª„ÉÑ„Éº„É´ -->
        <div class="flex flex-wrap gap-2 mb-2 justify-center">
            <button id="drawBtn" class="tool-button bg-white px-3 py-1 text-sm rounded-lg shadow hover:shadow-md">
                ‚úèÔ∏è „Éï„É™„Éº
            </button>
            <button id="straightLineBtn" class="tool-button bg-white px-3 py-1 text-sm rounded-lg shadow hover:shadow-md">
                üìè Áõ¥Á∑ö
            </button>
            <button id="arrowBtn" class="tool-button bg-white px-3 py-1 text-sm rounded-lg shadow hover:shadow-md">
                ‚û°Ô∏è Áü¢Âç∞
            </button>
            <button id="undoBtn" class="tool-button bg-white px-3 py-1 text-sm rounded-lg shadow hover:shadow-md">
                ‚Ü©Ô∏è Êàª„Çã
            </button>
        </div>

        <!-- „É°„Ç§„É≥„Ç≠„É£„É≥„Éê„Çπ„Ç®„É™„Ç¢ -->
        <div class="flex-grow flex justify-center overflow-hidden relative" style="min-height: 0;">
            <div class="relative w-full max-w-4xl h-full aspect-video bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                <!-- „Ç∑„Éº„Éà„Ç≥„É≥„ÉÜ„Éä -->
                <div id="sheetsContainer" class="w-full h-full">
                    <!-- „Ç∑„Éº„Éà1 („Éá„Éï„Ç©„É´„Éà) -->
                    <div id="sheet-1" class="sheet w-full h-full relative">
                        <!-- ÊèèÁîª„Ç≠„É£„É≥„Éê„Çπ -->
                        <canvas id="drawingCanvas-sheet-1" class="absolute top-0 left-0 w-full h-full z-10 drawing-board"></canvas>
                        
                        <!-- „Ç≥„Éº„Éà„É¨„Ç§„É§„Éº -->
                        <div id="court-sheet-1" class="absolute top-0 left-0 w-full h-full z-0 select-none">
                            <!-- „Éê„Çπ„Ç±„ÉÉ„Éà„Éú„Éº„É´„Ç≥„Éº„Éà („Éá„Éï„Ç©„É´„Éà) -->
                            <div id="basketballCourt-sheet-1" class="w-full h-full basketball-court flex items-center justify-center bg-gray-100">
                                <svg class="w-full h-full" viewBox="0 0 940 500" preserveAspectRatio="none">
                                    <rect x="0" y="0" width="940" height="500" fill="#BA8C63" />
                                    <!-- Â∑¶3P -->
                                    <path d="M20,100 L190,100 A170,170 0 0,1 190,400 L20,400 Z" class="three-point-area" />
                                    <!-- Âè≥3P -->
                                    <path d="M920,100 L750,100 A170,170 0 0,0 750,400 L920,400 Z" class="three-point-area" />
                                    <!-- „Ç≠„Éº„Ç®„É™„Ç¢ -->
                                    <rect x="20" y="150" width="170" height="200" class="key-area" />
                                    <rect x="750" y="150" width="170" height="200" class="key-area" />
                                    <!-- „É©„Ç§„É≥ -->
                                    <rect x="20" y="20" width="900" height="460" class="court-line" />
                                    <line x1="470" y1="20" x2="470" y2="480" class="court-line" />
                                    <circle cx="470" cy="250" r="60" class="court-circle" />
                                    <!-- „Éï„É™„Éº„Çπ„É≠„Éº -->
                                    <line x1="190" y1="100" x2="190" y2="400" class="court-line" stroke-dasharray="5,5" />
                                    <line x1="750" y1="100" x2="750" y2="400" class="court-line" stroke-dasharray="5,5" />
                                    <path d="M190,100 A60,60 0 0,0 190,400" class="court-circle" />
                                    <path d="M750,100 A60,60 0 0,1 750,400" class="court-circle" />
                                    <!-- „Ç¥„Éº„É´ -->
                                    <rect x="10" y="225" width="10" height="50" class="court-backboard" />
                                    <circle cx="30" cy="250" r="15" class="court-rim" />
                                    <rect x="920" y="225" width="10" height="50" class="court-backboard" />
                                    <circle cx="910" cy="250" r="15" class="court-rim" />
                                    <!-- 3P„É©„Ç§„É≥ -->
                                    <path d="M20,100 L190,100 A170,170 0 0,1 190,400 L20,400" class="court-line" fill="none" />
                                    <path d="M920,100 L750,100 A170,170 0 0,0 750,400 L920,400" class="court-line" fill="none" />
                                </svg>
                            </div>
                            
                            <!-- „Çµ„ÉÉ„Ç´„Éº„Ç≥„Éº„Éà -->
                            <div id="soccerCourt-sheet-1" class="w-full h-full bg-green-700 hidden flex items-center justify-center">
                                <svg class="w-full h-full" viewBox="0 0 940 500" preserveAspectRatio="none">
                                    <rect x="0" y="0" width="940" height="500" fill="#16a34a" />
                                    <rect x="20" y="20" width="900" height="460" class="court-line" />
                                    <line x1="470" y1="20" x2="470" y2="480" class="court-line" />
                                    <circle cx="470" cy="250" r="60" class="court-circle" />
                                    <rect x="20" y="125" width="120" height="250" class="court-area" />
                                    <rect x="800" y="125" width="120" height="250" class="court-area" />
                                    <rect x="20" y="175" width="60" height="150" class="court-area" />
                                    <rect x="860" y="175" width="60" height="150" class="court-area" />
                                    <!-- „Ç≥„Éº„Éä„Éº -->
                                    <path d="M20,20 A15,15 0 0,1 35,35" class="court-circle" />
                                    <path d="M20,480 A15,15 0 0,0 35,465" class="court-circle" />
                                    <path d="M920,20 A15,15 0 0,0 905,35" class="court-circle" />
                                    <path d="M920,480 A15,15 0 0,1 905,465" class="court-circle" />
                                </svg>
                            </div>

                            <!-- ÈáéÁêÉ„Ç≥„Éº„ÉàÔºàÂÜÖÈáéÊã°Â§ßÁâàÔºâ -->
                            <div id="baseballCourt-sheet-1" class="w-full h-full bg-green-700 hidden flex items-center justify-center">
                                <svg class="w-full h-full" viewBox="0 0 940 500" preserveAspectRatio="none">
                                    <!-- ËäùÁîü -->
                                    <rect x="0" y="0" width="940" height="500" fill="#16a34a" />
                                    
                                    <!-- ÂÜÖÈáéÂúü„Ç®„É™„Ç¢ (ÂÜÜÂΩ¢) - ÂçäÂæÑÊã°Â§ß -->
                                    <circle cx="470" cy="280" r="230" fill="#b45309" opacity="0.8" />
                                    
                                    <!-- „ÉÄ„Ç§„É§„É¢„É≥„ÉâÂÜÖ„ÅÆËäùÁîü„Ç®„É™„Ç¢ -->
                                    <rect x="470" y="180" width="130" height="130" transform="rotate(45 470 180)" fill="#16a34a" />

                                    <!-- „Éï„Ç°„Ç¶„É´„É©„Ç§„É≥ -->
                                    <line x1="470" y1="440" x2="50" y2="20" stroke="white" stroke-width="3" />
                                    <line x1="470" y1="440" x2="890" y2="20" stroke="white" stroke-width="3" />
                                    
                                    <!-- Â§ñÈáé„Éï„Çß„É≥„Çπ -->
                                    <path d="M50,20 Q470,-100 890,20" stroke="white" stroke-width="3" fill="none" />
                                    
                                    <!-- „ÉÄ„Ç§„É§„É¢„É≥„Éâ -->
                                    <path d="M470,440 L600,310 L470,180 L340,310 Z" fill="#b45309" stroke="white" stroke-width="3" />
                                    
                                    <!-- „Éô„Éº„Çπ -->
                                    <rect x="461" y="171" width="18" height="18" transform="rotate(45 470 180)" fill="white" />
                                    <rect x="331" y="301" width="18" height="18" transform="rotate(45 340 310)" fill="white" />
                                    <rect x="591" y="301" width="18" height="18" transform="rotate(45 600 310)" fill="white" />
                                    <polygon points="470,440 480,430 480,422 460,422 460,430" fill="white" />
                                    
                                    <!-- „Éî„ÉÉ„ÉÅ„É£„Éº„Éû„Ç¶„É≥„Éâ -->
                                    <circle cx="470" cy="323" r="12" fill="#b45309" stroke="white" stroke-width="1" />
                                    <rect x="462" y="320" width="16" height="6" fill="white" />
                                    
                                    <!-- „Éê„ÉÉ„Çø„Éº„Éú„ÉÉ„ÇØ„Çπ -->
                                    <rect x="425" y="420" width="30" height="40" fill="none" stroke="white" stroke-width="2" />
                                    <rect x="485" y="420" width="30" height="40" fill="none" stroke="white" stroke-width="2" />
                                    
                                    <!-- „Ç≥„Éº„ÉÅ„É£„Éº„Ç∫„Éú„ÉÉ„ÇØ„Çπ -->
                                    <rect x="240" y="300" width="30" height="60" fill="none" stroke="white" stroke-width="2" />
                                    <rect x="670" y="300" width="30" height="60" fill="none" stroke="white" stroke-width="2" />
                                </svg>
                            </div>
                            
                            <!-- „Éâ„ÉÉ„Ç∏„Éú„Éº„É´„Ç≥„Éº„Éà -->
                            <div id="dodgeballCourt-sheet-1" class="w-full h-full bg-amber-100 hidden flex items-center justify-center p-4">
                                <div class="w-full h-full border-4 border-red-800 bg-amber-50 relative box-border">
                                    <!-- „Çª„É≥„Çø„Éº„É©„Ç§„É≥ -->
                                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-0 h-full border-l-4 border-dashed border-red-800"></div>
                                </div>
                            </div>
                            
                            <!-- „Éê„É¨„Éº„Éú„Éº„É´„Ç≥„Éº„Éà -->
                            <div id="volleyballCourt-sheet-1" class="w-full h-full bg-amber-100 hidden flex items-center justify-center p-4">
                                <div class="w-full h-full border-4 border-blue-800 bg-amber-50 relative box-border">
                                    <!-- „Éç„ÉÉ„Éà -->
                                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-0 h-full border-l-4 border-black z-0"></div>
                                    <!-- „Ç¢„Çø„ÉÉ„ÇØ„É©„Ç§„É≥ (Â∑¶) -->
                                    <div class="absolute top-0 left-[30%] w-0 h-full border-l-4 border-dashed border-blue-800"></div>
                                    <!-- „Ç¢„Çø„ÉÉ„ÇØ„É©„Ç§„É≥ (Âè≥) -->
                                    <div class="absolute top-0 right-[30%] w-0 h-full border-l-4 border-dashed border-blue-800"></div>
                                </div>
                            </div>

                            <!-- „Åù„ÅÆ‰ªñÔºàÈï∑ÊñπÂΩ¢Ôºâ„Ç≥„Éº„Éà -->
                            <div id="otherCourt-sheet-1" class="w-full h-full bg-gray-200 hidden flex items-center justify-center">
                                <svg class="w-full h-full" viewBox="0 0 940 500" preserveAspectRatio="none">
                                    <rect x="0" y="0" width="940" height="500" fill="#f3f4f6" />
                                    <!-- Â§ñÊû† -->
                                    <rect x="20" y="20" width="900" height="460" class="other-court-rect" />
                                    <!-- ‰∏≠ÂøÉÁ∑ö (ËñÑ„Åè) -->
                                    <line x1="470" y1="20" x2="470" y2="480" stroke="#ddd" stroke-width="2" stroke-dasharray="5,5" />
                                </svg>
                            </div>
                        </div>

                        <!-- „Éó„É¨„Ç§„É§„Éº -->
                        <div id="players-sheet-1" class="absolute top-0 left-0 w-full h-full z-20 pointer-events-none overflow-hidden">
                            <!-- „Éó„É¨„Ç§„É§„Éº„ÅØJS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
                        </div>

                        <!-- „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éë„Çπ -->
                        <svg id="animationPaths-sheet-1" class="absolute top-0 left-0 w-full h-full z-15 pointer-events-none">
                            <!-- „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éë„Çπ„ÅØJS„ÅßÂãïÁöÑ„Å´ËøΩÂä† -->
                        </svg>
                    </div>
                </div>

                <!-- Áü¢Âç∞„Éó„É¨„Éì„É•„ÉºÁî®„ÅÆË¶ÅÁ¥† -->
                <svg id="arrowPreview" class="arrow-preview" style="display: none;">
                    <line id="arrowLine" x1="0" y1="0" x2="0" y2="0" stroke="black" stroke-width="3"></line>
                    <polygon id="arrowHead" points="" fill="black"></polygon>
                </svg>

                <!-- Áõ¥Á∑ö„Éó„É¨„Éì„É•„ÉºÁî®„ÅÆË¶ÅÁ¥† -->
                <svg id="linePreview" class="line-preview" style="display: none;">
                    <line id="straightLine" x1="0" y1="0" x2="0" y2="0" stroke="black" stroke-width="3"></line>
                </svg>
            </div>
        </div>

        <!-- „Éó„É¨„Ç§„É§„ÉºËøΩÂä†„ÉªÊìç‰Ωú„Ç®„É™„Ç¢ -->
        <div class="mt-2 pb-2 flex justify-center gap-2 flex-wrap">
            <button id="addRedPlayer" class="bg-red-500 text-white px-3 py-2 text-sm rounded-lg shadow hover:bg-red-600">
                Ëµ§„ÉÅ„Éº„É† üë§
            </button>
            <button id="addBluePlayer" class="bg-blue-500 text-white px-3 py-2 text-sm rounded-lg shadow hover:bg-blue-600">
                Èùí„ÉÅ„Éº„É† üë§
            </button>
             <!-- ÈªÑËâ≤„ÉÅ„Éº„É†ËøΩÂä† -->
            <button id="addYellowPlayer" class="bg-yellow-400 text-gray-800 px-3 py-2 text-sm rounded-lg shadow hover:bg-yellow-500 font-bold">
                ÈªÑ„ÉÅ„Éº„É† üë§
            </button>
            <button id="addBall" class="bg-orange-500 text-white px-3 py-2 text-sm rounded-lg shadow hover:bg-orange-600">
                „Éú„Éº„É´ ‚öæ
            </button>
            <div class="w-px h-8 bg-gray-300 mx-1"></div>
            <button id="playAnimation" class="bg-green-600 text-white px-4 py-2 text-sm rounded-lg shadow hover:bg-green-700 font-bold">
                ‚ñ∂Ô∏è ÂÜçÁîü
            </button>
            <button id="stopAnimation" class="bg-gray-500 text-white px-4 py-2 text-sm rounded-lg shadow hover:bg-gray-600 font-bold">
                ‚èπÔ∏è ÂÅúÊ≠¢
            </button>
        </div>
    </div>

    <!-- „Éó„É¨„Ç§„É§„Éº„É°„Éã„É•„Éº (ÂàùÊúüÁä∂ÊÖã„Åß„ÅØÈùûË°®Á§∫) -->
    <div id="playerMenu" class="player-menu" style="display: none;">
        <button id="movePlayerBtn" class="menu-button bg-blue-50 hover:bg-blue-100 text-blue-700">
            ÁßªÂãï („Éâ„É©„ÉÉ„Ç∞)
        </button>
        <button id="animatePlayerBtn" class="menu-button bg-green-50 hover:bg-green-100 text-green-700">
            „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁßªÂãïË®≠ÂÆö
        </button>
        <button id="deletePlayerBtn" class="menu-button bg-red-50 hover:bg-red-100 text-red-700">
            ÂâäÈô§
        </button>
    </div>

<script>
    // „Ç∑„Éº„ÉàÁÆ°ÁêÜ
    let currentSheetId = 'sheet-1';
    let sheetCounter = 1;
    let currentCourtType = 'basketball'; // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç≥„Éº„Éà„Çø„Ç§„Éó
    let sheetNames = { 'sheet-1': '„Ç∑„Éº„Éà1' };
    
    // „Ç≥„Éº„Éà„Çø„Ç§„Éó‰∏ÄË¶ßÔºà„Åù„ÅÆ‰ªñ„ÇíËøΩÂä†Ôºâ
    const courtTypes = ['basketball', 'soccer', 'baseball', 'dodgeball', 'volleyball', 'other'];

    // ÊèèÁîªÂ±•Ê≠¥„ÅÆ‰øùÂ≠ò
    let drawingHistory = {
        'sheet-1': []
    };
    
    // „Ç∑„Éº„Éà„Åî„Å®„ÅÆ„Éó„É¨„Ç§„É§„Éº„Ç´„Ç¶„É≥„Çø„ÉºÔºàÈªÑËâ≤„ÇíËøΩÂä†Ôºâ
    let playerCounters = {
        'sheet-1': {
            red: 0,
            blue: 0,
            yellow: 0,
            ball: 0
        }
    };
    
    // ‰ΩúÊà¶Âêç„ÅÆÂÖ•Âäõ„Ç§„Éô„É≥„Éà
    document.getElementById('strategyName').addEventListener('input', function(e) {
        const name = e.target.value || `„Ç∑„Éº„Éà${currentSheetId.split('-')[1]}`;
        sheetNames[currentSheetId] = name;
        
        // „Çø„Éñ„ÅÆÂêçÂâç„ÇíÊõ¥Êñ∞
        const tab = document.querySelector(`.sheet-tab[data-sheet-id="${currentSheetId}"]`);
        if (tab) {
            tab.textContent = name;
        }
    });
    
    // „Ç∑„Éº„ÉàÂàá„ÇäÊõø„ÅàÊôÇ„Å´‰ΩúÊà¶Âêç„ÇíÊõ¥Êñ∞
    function updateStrategyNameInput() {
        const input = document.getElementById('strategyName');
        input.value = sheetNames[currentSheetId] || '';
    }
    
    // „Ç∑„Éº„ÉàËøΩÂä†„Éú„Çø„É≥
    document.getElementById('addSheetBtn').addEventListener('click', () => {
        sheetCounter++;
        const newSheetId = `sheet-${sheetCounter}`;
        const defaultName = `„Ç∑„Éº„Éà${sheetCounter}`;
        sheetNames[newSheetId] = defaultName;
        
        // ÊèèÁîªÂ±•Ê≠¥„ÅÆÂàùÊúüÂåñ
        drawingHistory[newSheetId] = [];
        
        // Êñ∞„Åó„ÅÑ„Ç∑„Éº„Éà„ÅÆ„Éó„É¨„Ç§„É§„Éº„Ç´„Ç¶„É≥„Çø„Éº„ÇíÂàùÊúüÂåñÔºàÈªÑËâ≤Âê´„ÇÄÔºâ
        playerCounters[newSheetId] = {
            red: 0,
            blue: 0,
            yellow: 0,
            ball: 0
        };
        
        // „Çø„Éñ„ÇíËøΩÂä†
        const tabsContainer = document.getElementById('sheetTabsContainer');
        const newTab = document.createElement('button');
        newTab.className = 'sheet-tab bg-white px-3 py-1 rounded-lg shadow hover:shadow-md';
        newTab.dataset.sheetId = newSheetId;
        newTab.textContent = defaultName;
        tabsContainer.insertBefore(newTab, document.getElementById('addSheetBtn'));
        
        // „Ç∑„Éº„Éà„ÇíËøΩÂä†
        const sheetsContainer = document.getElementById('sheetsContainer');
        const newSheet = document.createElement('div');
        newSheet.id = newSheetId;
        newSheet.className = 'sheet w-full h-full relative hidden';
        
        // „Ç≠„É£„É≥„Éê„Çπ„ÇíËøΩÂä†
        const canvas = document.createElement('canvas');
        canvas.id = `drawingCanvas-${newSheetId}`;
        canvas.className = 'absolute top-0 left-0 w-full h-full z-10 drawing-board';
        newSheet.appendChild(canvas);
        
        // „Ç≥„Éº„Éà„ÇíËøΩÂä†
        const court = document.createElement('div');
        court.id = `court-${newSheetId}`;
        court.className = 'absolute top-0 left-0 w-full h-full z-0 select-none';
        
        // ÂêÑÁ®Æ„Ç≥„Éº„Éà„ÇíËøΩÂä†
        courtTypes.forEach(type => {
            const source = document.getElementById(`${type}Court-sheet-1`);
            if(source) {
                const courtElement = source.cloneNode(true);
                courtElement.id = `${type}Court-${newSheetId}`;
                if (type !== currentCourtType) {
                    courtElement.classList.add('hidden');
                    courtElement.classList.remove('flex'); // hidden„Åå„Å§„Åè„Å®flex„ÇÇÊ∂à„Åà„Çã„Åå„ÄÅË°®Á§∫ÊôÇ„Å´Êàª„Åô„Åü„ÇÅ
                } else {
                    courtElement.classList.remove('hidden');
                    courtElement.classList.add('flex');
                }
                court.appendChild(courtElement);
            }
        });
        
        newSheet.appendChild(court);
        
        // „Éó„É¨„Ç§„É§„Éº„Ç≥„É≥„ÉÜ„Éä„ÇíËøΩÂä†
        const playersContainer = document.createElement('div');
        playersContainer.id = `players-${newSheetId}`;
        playersContainer.className = 'absolute top-0 left-0 w-full h-full z-20 pointer-events-none overflow-hidden';
        newSheet.appendChild(playersContainer);
        
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éë„Çπ„Ç≥„É≥„ÉÜ„Éä„ÇíËøΩÂä†
        const animationPathsContainer = document.createElement('svg');
        animationPathsContainer.id = `animationPaths-${newSheetId}`;
        animationPathsContainer.className = 'absolute top-0 left-0 w-full h-full z-15 pointer-events-none';
        newSheet.appendChild(animationPathsContainer);
        
        sheetsContainer.appendChild(newSheet);
        
        // Êñ∞„Åó„ÅÑ„Ç∑„Éº„Éà„Å´Âàá„ÇäÊõø„Åà
        switchToSheet(newSheetId);
        
        // „Ç≠„É£„É≥„Éê„Çπ„ÅÆÂàùÊúüÂåñ
        initializeCanvas(canvas);
    });
    
    // „Ç∑„Éº„ÉàÂàá„ÇäÊõø„Åà
    function switchToSheet(sheetId) {
        // ÁèæÂú®„ÅÆ„Ç∑„Éº„Éà„ÇíÈùûË°®Á§∫
        document.getElementById(currentSheetId).classList.add('hidden');
        
        // Êñ∞„Åó„ÅÑ„Ç∑„Éº„Éà„ÇíË°®Á§∫
        document.getElementById(sheetId).classList.remove('hidden');
        
        // „Çø„Éñ„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        document.querySelectorAll('.sheet-tab').forEach(tab => {
            if (tab.dataset.sheetId === sheetId) {
                tab.classList.add('active');
            } else {
                tab.classList.remove('active');
            }
        });
        
        currentSheetId = sheetId;
        updateStrategyNameInput();
        
        // ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É¨„Ç§„É§„Éº„Çí„ÇØ„É™„Ç¢
        selectedPlayer = null;
        hidePlayerMenu();
        animationMode = false;
        
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíÂâäÈô§
        removeAnimationTarget();
        
        // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫ÂÜçË®àÁÆó
        const canvas = document.getElementById(`drawingCanvas-${sheetId}`);
        if(canvas) initializeCanvas(canvas);
    }
    
    // „Çø„Éñ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    document.getElementById('sheetTabsContainer').addEventListener('click', (e) => {
        if (e.target.classList.contains('sheet-tab') && e.target.id !== 'addSheetBtn') {
            switchToSheet(e.target.dataset.sheetId);
        }
    });

    // „Ç≥„Éº„ÉàÂàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÅÆË®≠ÂÆöÔºà„Åù„ÅÆ‰ªñ„ÇíËøΩÂä†Ôºâ
    const courtButtons = ['basketballBtn', 'soccerBtn', 'baseballBtn', 'dodgeballBtn', 'volleyballBtn', 'otherBtn'];
    
    courtButtons.forEach((btnId, index) => {
        document.getElementById(btnId).addEventListener('click', () => {
            // „Éú„Çø„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            courtButtons.forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById(btnId).classList.add('active');
            
            // ÂÖ®„Ç∑„Éº„Éà„ÅÆ„Ç≥„Éº„Éà„ÇíÂàá„ÇäÊõø„Åà
            const courtType = courtTypes[index];
            currentCourtType = courtType;
            
            document.querySelectorAll('.sheet').forEach(sheet => {
                const sheetId = sheet.id;
                
                // „Ç≥„Éº„Éà„ÅÆË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
                courtTypes.forEach(type => {
                    const courtElement = document.getElementById(`${type}Court-${sheetId}`);
                    if (courtElement) {
                        if (type === courtType) {
                            courtElement.classList.remove('hidden');
                            courtElement.classList.add('flex');
                        } else {
                            courtElement.classList.add('hidden');
                            courtElement.classList.remove('flex');
                        }
                    }
                });
            });
            
            // „Éú„Éº„É´„ÅÆ„Éá„Ç∂„Ç§„É≥„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.player[data-type="ball"]').forEach(ball => {
                ball.innerHTML = getBallEmoji(courtType);
            });
        });
    });

    // „Éó„É¨„Ç§„É§„ÉºËøΩÂä†„Å®Êìç‰Ωú
    let selectedPlayer = null;
    let animationMode = false;
    let playerAnimations = {};
    
    // „Éú„Éº„É´„ÅÆÁµµÊñáÂ≠ó
    const getBallEmoji = (type) => {
        switch(type) {
            case 'basketball': return `<div class="ball-emoji">üèÄ</div>`;
            case 'soccer': return `<div class="ball-emoji">‚öΩ</div>`;
            case 'baseball': return `<div class="ball-emoji">‚öæ</div>`;
            case 'dodgeball': return `<div class="ball-emoji">üî¥</div>`;
            case 'volleyball': return `<div class="ball-emoji">üèê</div>`;
            default: return `<div class="ball-emoji">‚öæ</div>`;
        }
    };
    
    // „Éó„É¨„Ç§„É§„Éº„É°„Éã„É•„Éº
    const playerMenu = document.getElementById('playerMenu');
    const movePlayerBtn = document.getElementById('movePlayerBtn');
    const animatePlayerBtn = document.getElementById('animatePlayerBtn');
    const deletePlayerBtn = document.getElementById('deletePlayerBtn');
    
    function showPlayerMenu(player, x, y) {
        playerMenu.style.display = 'block';
        
        // „É°„Éã„É•„Éº„ÅåÁîªÈù¢Â§ñ„Å´Âá∫„Å™„ÅÑ„Çà„ÅÜ„Å´Ë™øÊï¥
        const menuWidth = 150;
        const menuHeight = 120;
        const screenWidth = window.innerWidth;
        const screenHeight = window.innerHeight;
        
        let finalX = x;
        let finalY = y;
        
        if (x + menuWidth > screenWidth) finalX = screenWidth - menuWidth - 10;
        if (y + menuHeight > screenHeight) finalY = screenHeight - menuHeight - 10;
        
        playerMenu.style.left = `${finalX}px`;
        playerMenu.style.top = `${finalY}px`;
        
        selectedPlayer = player;
        
        document.querySelectorAll('.player').forEach(p => {
            if (p !== player) p.classList.remove('selected');
        });
        player.classList.add('selected');
    }
    
    function hidePlayerMenu() {
        playerMenu.style.display = 'none';
    }
    
    movePlayerBtn.addEventListener('click', () => {
        hidePlayerMenu();
        showMessage('„Éó„É¨„Ç§„É§„Éº„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁßªÂãï„Åß„Åç„Åæ„Åô', 1000);
    });
    
    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çø„Éº„Ç≤„ÉÉ„ÉàË¶ÅÁ¥†
    function createAnimationTarget() {
        removeAnimationTarget();
        const target = document.createElement('div');
        target.id = 'animationTarget';
        target.className = 'animation-target';
        document.getElementById(currentSheetId).appendChild(target);
        return target;
    }
    
    function removeAnimationTarget() {
        const target = document.getElementById('animationTarget');
        if (target) target.remove();
    }
    
    animatePlayerBtn.addEventListener('click', () => {
        hidePlayerMenu();
        animationMode = true;
        createAnimationTarget();
        showMessage('ÁßªÂãïÂÖà„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 2000);
    });
    
    deletePlayerBtn.addEventListener('click', () => {
        if (selectedPlayer) {
            const playerId = selectedPlayer.dataset.id;
            
            const pathId = `path-${playerId}`;
            const path = document.getElementById(pathId);
            if (path) path.remove();
            
            const arrowId = `arrow-${playerId}`;
            const arrow = document.getElementById(arrowId);
            if (arrow) arrow.remove();
            
            if (playerAnimations[playerId]) delete playerAnimations[playerId];
            
            selectedPlayer.remove();
            selectedPlayer = null;
        }
        hidePlayerMenu();
    });
    
    function showMessage(text, duration = 2000) {
        const existingMsg = document.getElementById('message-box');
        if (existingMsg) existingMsg.remove();
        
        const msg = document.createElement('div');
        msg.id = 'message-box';
        msg.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-4 py-2 rounded-lg z-50 pointer-events-none transition-opacity';
        msg.textContent = text;
        
        document.body.appendChild(msg);
        
        setTimeout(() => {
            msg.style.opacity = '0';
            setTimeout(() => msg.remove(), 500);
        }, duration);
    }
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#playerMenu') && !e.target.closest('.player')) {
            hidePlayerMenu();
            if (!animationMode) {
                document.querySelectorAll('.player').forEach(p => p.classList.remove('selected'));
                selectedPlayer = null;
            }
        }
    });
    
    function createPlayer(color, isPlayer = true) {
        const playersContainer = document.getElementById(`players-${currentSheetId}`);
        let playerNumber;
        
        if (isPlayer) {
            if (color === 'red') {
                playerCounters[currentSheetId].red++;
                playerNumber = playerCounters[currentSheetId].red;
            } else if (color === 'blue') {
                playerCounters[currentSheetId].blue++;
                playerNumber = playerCounters[currentSheetId].blue;
            } else if (color === 'yellow') {
                playerCounters[currentSheetId].yellow++;
                playerNumber = playerCounters[currentSheetId].yellow;
            }
        } else {
            playerCounters[currentSheetId].ball++;
        }
        
        const player = document.createElement('div');
        // ID„Å´yellow„ÇíËøΩÂä†„Åß„Åç„Çã„Çà„ÅÜ„Å´‰øÆÊ≠£
        const countVal = isPlayer ? playerNumber : playerCounters[currentSheetId].ball;
        player.className = `player absolute z-30 pointer-events-auto select-none touch-none`; // touch-none„ÇíËøΩÂä†
        player.dataset.type = isPlayer ? color : 'ball';
        player.dataset.id = `${color}-${countVal}-${currentSheetId}`;
        
        if (isPlayer) {
            // Ëâ≤„ÇØ„É©„Çπ„ÅÆÊ±∫ÂÆö
            let bgClass = '';
            if (color === 'red') bgClass = 'bg-red-500';
            else if (color === 'blue') bgClass = 'bg-blue-500';
            else if (color === 'yellow') bgClass = 'bg-yellow-400';

            const playerDiv = document.createElement('div');
            playerDiv.className = `w-10 h-10 md:w-12 md:h-12 rounded-full ${bgClass} flex items-center justify-center relative shadow-md`;
            
            const numberSpan = document.createElement('span');
            numberSpan.className = 'player-number';
            numberSpan.textContent = playerNumber;
            playerDiv.appendChild(numberSpan);
            
            player.appendChild(playerDiv);
        } else {
            player.innerHTML = getBallEmoji(currentCourtType);
        }
        
        // ÈÖçÁΩÆ‰ΩçÁΩÆÔºàÂ∞ë„Åó‰∏≠Â§ÆÂØÑ„Çä„Å´Ôºâ
        const courtEl = document.getElementById(`court-${currentSheetId}`);
        const cw = courtEl.offsetWidth || 800;
        const ch = courtEl.offsetHeight || 500;
        
        player.style.left = `${Math.random() * (cw * 0.5) + cw * 0.25}px`;
        player.style.top = `${Math.random() * (ch * 0.5) + ch * 0.25}px`;
        
        playersContainer.appendChild(player);
        
        // „Ç§„Éô„É≥„ÉàË®≠ÂÆö
        player.addEventListener('click', (e) => {
            e.stopPropagation();
            if (animationMode) return;
            const rect = player.getBoundingClientRect();
            showPlayerMenu(player, rect.right + 5, rect.top);
        });
        
        // „Éâ„É©„ÉÉ„Ç∞Âá¶ÁêÜ
        let isDragging = false;
        let startX, startY;
        let initLeft, initTop;
        
        const startDrag = (e) => {
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É¢„Éº„Éâ„ÇÑ„É°„Éã„É•„ÉºË°®Á§∫‰∏≠„ÅØ„Éâ„É©„ÉÉ„Ç∞„Åó„Å™„ÅÑ
            if(animationMode) return;
            
            e.preventDefault(); // „Çø„ÉÉ„ÉÅ„Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢
            e.stopPropagation();
            
            isDragging = true;
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            startX = clientX;
            startY = clientY;
            initLeft = parseFloat(player.style.left) || 0;
            initTop = parseFloat(player.style.top) || 0;
            
            // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„É™„Çπ„Éä„ÉºËøΩÂä†
            if (e.type.includes('touch')) {
                document.addEventListener('touchmove', onDrag, { passive: false });
                document.addEventListener('touchend', endDrag);
            } else {
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', endDrag);
            }
        };
        
        const onDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            const dx = clientX - startX;
            const dy = clientY - startY;
            
            const container = document.getElementById(`sheetsContainer`);
            const rect = container.getBoundingClientRect();
            const maxW = rect.width - player.offsetWidth;
            const maxH = rect.height - player.offsetHeight;

            let newLeft = initLeft + dx;
            let newTop = initTop + dy;
            
            // ÁîªÈù¢Â§ñ„Å´„ÅØ„ÅøÂá∫„ÅóÈò≤Ê≠¢
            newLeft = Math.max(0, Math.min(newLeft, maxW));
            newTop = Math.max(0, Math.min(newTop, maxH));
            
            player.style.left = `${newLeft}px`;
            player.style.top = `${newTop}px`;
            
            // „Éë„Çπ„Åå„ÅÇ„Çå„Å∞ÂâäÈô§Ôºà‰ΩçÁΩÆ„ÅåÂ§â„Çè„Å£„Åü„Åü„ÇÅÔºâ
            if (playerAnimations[player.dataset.id]) {
                const pid = player.dataset.id;
                const path = document.getElementById(`path-${pid}`);
                if(path) path.remove();
                const arrow = document.getElementById(`arrow-${pid}`);
                if(arrow) arrow.remove();
                delete playerAnimations[pid];
            }
        };
        
        const endDrag = () => {
            isDragging = false;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', endDrag);
        };
        
        player.addEventListener('mousedown', startDrag);
        player.addEventListener('touchstart', startDrag, { passive: false });
    }
    
    document.getElementById('addRedPlayer').addEventListener('click', () => createPlayer('red'));
    document.getElementById('addBluePlayer').addEventListener('click', () => createPlayer('blue'));
    document.getElementById('addYellowPlayer').addEventListener('click', () => createPlayer('yellow'));
    document.getElementById('addBall').addEventListener('click', () => createPlayer('ball', false));

    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éë„ÇπË®≠ÂÆö
    document.addEventListener('click', (e) => {
        if (!animationMode || !selectedPlayer) return;
        
        const sheet = document.getElementById(currentSheetId);
        // „Éó„É¨„Ç§„É§„ÉºËá™Ë∫´„ÇÑ„É°„Éã„É•„Éº„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÅØÈô§Â§ñ
        if (e.target.closest('.player') || e.target.closest('#playerMenu')) return;
        
        const rect = sheet.getBoundingClientRect();
        
        // „Ç∑„Éº„ÉàÂ§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅØÁÑ°Ë¶ñ
        if (e.clientX < rect.left || e.clientX > rect.right || 
            e.clientY < rect.top || e.clientY > rect.bottom) return;

        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        const target = document.getElementById('animationTarget');
        if (target) {
            target.style.left = `${x}px`;
            target.style.top = `${y}px`;
        }
        
        const playerRect = selectedPlayer.getBoundingClientRect();
        // Ë¶™Ë¶ÅÁ¥†ÂÜÖ„Åß„ÅÆÁõ∏ÂØæÂ∫ßÊ®ô„ÇíË®àÁÆó
        const pLeft = parseFloat(selectedPlayer.style.left);
        const pTop = parseFloat(selectedPlayer.style.top);
        const playerCenterX = pLeft + selectedPlayer.offsetWidth / 2;
        const playerCenterY = pTop + selectedPlayer.offsetHeight / 2;
        
        const pathsContainer = document.getElementById(`animationPaths-${currentSheetId}`);
        const playerId = selectedPlayer.dataset.id;
        const pathId = `path-${playerId}`;
        
        // Êó¢Â≠òÂâäÈô§
        const existingPath = document.getElementById(pathId);
        if (existingPath) existingPath.remove();
        const existingArrow = document.getElementById(`arrow-${playerId}`);
        if (existingArrow) existingArrow.remove();
        
        // Á∑ö„ÅÆËâ≤Ë®≠ÂÆöÔºàÈªÑËâ≤„ÉÅ„Éº„É†ÂØæÂøúÔºâ
        let strokeColor = '#000';
        if (selectedPlayer.dataset.type === 'red') strokeColor = '#ef4444';
        else if (selectedPlayer.dataset.type === 'blue') strokeColor = '#3b82f6';
        else if (selectedPlayer.dataset.type === 'yellow') strokeColor = '#eab308'; // ÈªÑËâ≤
        else strokeColor = '#f97316'; // „Éú„Éº„É´
        
        // „Éë„Çπ‰ΩúÊàê
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.id = pathId;
        path.setAttribute('d', `M${playerCenterX},${playerCenterY} L${x},${y}`);
        path.setAttribute('stroke', strokeColor);
        path.setAttribute('stroke-width', '3');
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke-dasharray', '5');
        path.classList.add('animation-path');
        pathsContainer.appendChild(path);
        
        // Áü¢Âç∞ÂÖàÁ´Ø
        const arrowId = `arrow-${playerId}`;
        const angle = Math.atan2(y - playerCenterY, x - playerCenterX);
        const arrowLen = 15;
        const arrowX = x - 5 * Math.cos(angle);
        const arrowY = y - 5 * Math.sin(angle);
        
        const x1 = arrowX - arrowLen * Math.cos(angle - Math.PI / 6);
        const y1 = arrowY - arrowLen * Math.sin(angle - Math.PI / 6);
        const x2 = arrowX - arrowLen * Math.cos(angle + Math.PI / 6);
        const y2 = arrowY - arrowLen * Math.sin(angle + Math.PI / 6);
        
        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        arrow.id = arrowId;
        arrow.setAttribute('points', `${arrowX},${arrowY} ${x1},${y1} ${x2},${y2}`);
        arrow.setAttribute('fill', strokeColor);
        pathsContainer.appendChild(arrow);
        
        // ‰øùÂ≠ò
        playerAnimations[playerId] = {
            startX: pLeft,
            startY: pTop,
            endX: x - selectedPlayer.offsetWidth / 2,
            endY: y - selectedPlayer.offsetHeight / 2
        };
        
        animationMode = false;
        selectedPlayer.classList.remove('selected');
        selectedPlayer = null;
        
        setTimeout(() => removeAnimationTarget(), 500);
        showMessage('ÁßªÂãïÂÖà„ÇíË®≠ÂÆö„Åó„Åæ„Åó„Åü', 1500);
    });
    
    // ÂÜçÁîü„ÉªÂÅúÊ≠¢
    document.getElementById('playAnimation').addEventListener('click', () => {
        const players = document.getElementById(`players-${currentSheetId}`).querySelectorAll('.player');
        let count = 0;
        players.forEach(p => {
            const anim = playerAnimations[p.dataset.id];
            if (anim) {
                count++;
                p.style.transition = 'left 1.5s ease-in-out, top 1.5s ease-in-out';
                p.style.left = `${anim.endX}px`;
                p.style.top = `${anim.endY}px`;
            }
        });
        if(count > 0) showMessage('ÂÜçÁîü‰∏≠...', 1500);
        else showMessage('„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 1500);
    });
    
    document.getElementById('stopAnimation').addEventListener('click', () => {
        const players = document.getElementById(`players-${currentSheetId}`).querySelectorAll('.player');
        players.forEach(p => {
            const anim = playerAnimations[p.dataset.id];
            if (anim) {
                p.style.transition = 'none';
                p.style.left = `${anim.startX}px`;
                p.style.top = `${anim.startY}px`;
            }
        });
        showMessage('‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 1000);
    });

    // ÊèèÁîªÊ©üËÉΩ (Canvas) - ‰øÆÊ≠£Ê∏à„Åø: „Ç®„É©„ÉºÂØæÁ≠ñ„Å®„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆÊèèÁîª‰øùÊåÅ
    function initializeCanvas(canvas) {
        // „Ç≥„É≥„ÉÜ„Éä„ÅÆ„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Çã
        const parent = canvas.parentElement;
        const rect = parent.getBoundingClientRect();
        
        // „Çµ„Ç§„Ç∫„Åå0„ÅÆÂ†¥Âêà„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑÔºà„Ç®„É©„ÉºÂõûÈÅøÔºâ
        if (rect.width === 0 || rect.height === 0) return;

        // ÁèæÂú®„ÅÆ„Çµ„Ç§„Ç∫„Å®Âêå„Åò„Å™„Çâ„É™„Çµ„Ç§„Ç∫„Åó„Å™„ÅÑÔºàÂÜÖÂÆπ‰øùÊåÅÔºâ
        if (canvas.width !== rect.width || canvas.height !== rect.height) {
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // „Çµ„Ç§„Ç∫„ÅåÂ§â„Çè„Çã„Å®ÂÜÖÂÆπ„ÅåÊ∂à„Åà„Çã„ÅÆ„ÅßÂ±•Ê≠¥„Åã„ÇâÂÜçÊèèÁîª
            const sheetId = canvas.id.split('drawingCanvas-')[1];
            redrawCanvasForSheet(sheetId);
        }
        
        const ctx = canvas.getContext('2d');
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // „É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆÂá¶ÁêÜ
        if(!canvas.dataset.resizeListenerAttached) {
            window.addEventListener('resize', () => {
                // ÈùûË°®Á§∫„Å™„Å©„Åß„Çµ„Ç§„Ç∫„Åå0„ÅÆÊôÇ„ÅØÁÑ°Ë¶ñ
                if (parent.clientWidth === 0 || parent.clientHeight === 0) return;
                
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
                
                // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàË®≠ÂÆö„ÇÇ„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã„Åü„ÇÅÂÜçË®≠ÂÆö
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Â±•Ê≠¥„Åã„ÇâÂÜçÊèèÁîª
                const sheetId = canvas.id.split('drawingCanvas-')[1];
                redrawCanvasForSheet(sheetId);
            });
            canvas.dataset.resizeListenerAttached = 'true';
        }
    }

    // ÊåáÂÆö„Ç∑„Éº„Éà„ÅÆ„Ç≠„É£„É≥„Éê„Çπ„ÇíÂ±•Ê≠¥„Åã„ÇâÂÜçÊèèÁîª„Åô„ÇãÈñ¢Êï∞
    function redrawCanvasForSheet(sheetId) {
        const canvas = document.getElementById(`drawingCanvas-${sheetId}`);
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const history = drawingHistory[sheetId];
        if(!history) return;
        
        history.forEach(item => {
            ctx.beginPath();
            ctx.strokeStyle = item.color;
            ctx.lineWidth = item.width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (item.type === 'line') {
                ctx.moveTo(item.startX, item.startY);
                ctx.lineTo(item.endX, item.endY);
                ctx.stroke();
            } else if (item.type === 'arrow') {
                drawArrowOnCanvas(ctx, item.startX, item.startY, item.endX, item.endY, item.color, item.width);
            } else if (item.type === 'straightLine') {
                ctx.moveTo(item.startX, item.startY);
                ctx.lineTo(item.endX, item.endY);
                ctx.stroke();
            }
        });
    }
    
    // ÂàùÊúüÂåñ
    initializeCanvas(document.getElementById('drawingCanvas-sheet-1'));
    
    // ÊèèÁîª„ÉÑ„Éº„É´
    let currentTool = 'none';
    let isDrawing = false;
    let lastX = 0, lastY = 0;
    let drawStartX = 0, drawStartY = 0;
    
    const arrowPreview = document.getElementById('arrowPreview');
    const arrowLine = document.getElementById('arrowLine');
    const arrowHead = document.getElementById('arrowHead');
    const linePreview = document.getElementById('linePreview');
    const straightLine = document.getElementById('straightLine');
    
    const toolButtons = ['drawBtn', 'straightLineBtn', 'arrowBtn', 'undoBtn'];
    
    toolButtons.forEach(btnId => {
        document.getElementById(btnId).addEventListener('click', () => {
            if (btnId === 'undoBtn') {
                undoLastDrawing();
                return;
            }
            toolButtons.forEach(id => {
                if(id !== 'undoBtn') document.getElementById(id).classList.remove('active');
            });
            
            if (currentTool === btnId.replace('Btn', '')) {
                currentTool = 'none';
            } else {
                document.getElementById(btnId).classList.add('active');
                currentTool = btnId.replace('Btn', '');
            }
        });
    });
    
    function undoLastDrawing() {
        const history = drawingHistory[currentSheetId];
        if (history && history.length > 0) {
            history.pop();
            redrawCanvasForSheet(currentSheetId); // ‰øÆÊ≠£ÔºöÊ±éÁî®Èñ¢Êï∞„Çí‰ΩøÁî®
            showMessage('1„Å§Êàª„Çä„Åæ„Åó„Åü', 1000);
        } else {
            showMessage('„Åì„Çå‰ª•‰∏äÊàª„Çå„Åæ„Åõ„Çì', 1000);
        }
    }
    
    // ÊèèÁîª„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
    const canvasContainer = document.getElementById('sheetsContainer');
    
    const getCanvasCoords = (e, canvas) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    };
    
    const startDrawing = (e) => {
        if (currentTool === 'none') return;
        if (e.target.closest('.player')) return; // „Éó„É¨„Ç§„É§„Éº‰∏ä„ÅØÊèèÁîª„Åó„Å™„ÅÑ
        
        const canvas = document.getElementById(`drawingCanvas-${currentSheetId}`);
        // „Ç§„Éô„É≥„Éà„Çø„Éº„Ç≤„ÉÉ„Éà„ÅåCanvas„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
        if(e.target !== canvas) return;
        
        e.preventDefault();
        
        isDrawing = true;
        const coords = getCanvasCoords(e, canvas);
        lastX = coords.x;
        lastY = coords.y;
        drawStartX = coords.x;
        drawStartY = coords.y;
        
        const rect = canvas.getBoundingClientRect();
        
        if (currentTool === 'arrow') {
            arrowPreview.style.display = 'block';
            arrowPreview.style.left = rect.left + 'px'; // Canvas„Åß„ÅØ„Å™„ÅèË¶™Âü∫Ê∫ñ„ÅÆÂ†¥Âêà„ÅØÊ≥®ÊÑè
            arrowPreview.style.top = rect.top + 'px';
            arrowPreview.style.width = rect.width + 'px';
            arrowPreview.style.height = rect.height + 'px';
            
            arrowLine.setAttribute('x1', drawStartX);
            arrowLine.setAttribute('y1', drawStartY);
            arrowLine.setAttribute('x2', drawStartX);
            arrowLine.setAttribute('y2', drawStartY);
        } else if (currentTool === 'straightLine') {
            linePreview.style.display = 'block';
            linePreview.style.left = rect.left + 'px';
            linePreview.style.top = rect.top + 'px';
            linePreview.style.width = rect.width + 'px';
            linePreview.style.height = rect.height + 'px';
            
            straightLine.setAttribute('x1', drawStartX);
            straightLine.setAttribute('y1', drawStartY);
            straightLine.setAttribute('x2', drawStartX);
            straightLine.setAttribute('y2', drawStartY);
        }
    };
    
    const processDrawing = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        
        const canvas = document.getElementById(`drawingCanvas-${currentSheetId}`);
        const coords = getCanvasCoords(e, canvas);
        const ctx = canvas.getContext('2d');
        
        if (currentTool === 'draw') {
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(coords.x, coords.y);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            drawingHistory[currentSheetId].push({
                type: 'line',
                startX: lastX,
                startY: lastY,
                endX: coords.x,
                endY: coords.y,
                color: '#000',
                width: 3
            });
            
            lastX = coords.x;
            lastY = coords.y;
        } else if (currentTool === 'arrow') {
            arrowLine.setAttribute('x2', coords.x);
            arrowLine.setAttribute('y2', coords.y);
            
            // Áü¢Âç∞ÂÖàÁ´ØË®àÁÆó
            const headLen = 15;
            const angle = Math.atan2(coords.y - drawStartY, coords.x - drawStartX);
            const x1 = coords.x - headLen * Math.cos(angle - Math.PI / 6);
            const y1 = coords.y - headLen * Math.sin(angle - Math.PI / 6);
            const x2 = coords.x - headLen * Math.cos(angle + Math.PI / 6);
            const y2 = coords.y - headLen * Math.sin(angle + Math.PI / 6);
            arrowHead.setAttribute('points', `${coords.x},${coords.y} ${x1},${y1} ${x2},${y2}`);
            
        } else if (currentTool === 'straightLine') {
            straightLine.setAttribute('x2', coords.x);
            straightLine.setAttribute('y2', coords.y);
        }
    };
    
    const stopDrawing = (e) => {
        if (!isDrawing) return;
        isDrawing = false;
        
        const canvas = document.getElementById(`drawingCanvas-${currentSheetId}`);
        const ctx = canvas.getContext('2d');
        
        // Áõ¥Á∑ö„ÉÑ„Éº„É´„ÅÆÁ¢∫ÂÆöÂá¶ÁêÜ
        if (currentTool === 'arrow') {
            const x1 = parseFloat(arrowLine.getAttribute('x1'));
            const y1 = parseFloat(arrowLine.getAttribute('y1'));
            const x2 = parseFloat(arrowLine.getAttribute('x2'));
            const y2 = parseFloat(arrowLine.getAttribute('y2'));
            
            drawArrowOnCanvas(ctx, x1, y1, x2, y2, '#000', 3);
            drawingHistory[currentSheetId].push({ type: 'arrow', startX: x1, startY: y1, endX: x2, endY: y2, color: '#000', width: 3 });
            arrowPreview.style.display = 'none';
            
        } else if (currentTool === 'straightLine') {
            const x1 = parseFloat(straightLine.getAttribute('x1'));
            const y1 = parseFloat(straightLine.getAttribute('y1'));
            const x2 = parseFloat(straightLine.getAttribute('x2'));
            const y2 = parseFloat(straightLine.getAttribute('y2'));
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.stroke();
            drawingHistory[currentSheetId].push({ type: 'straightLine', startX: x1, startY: y1, endX: x2, endY: y2, color: '#000', width: 3 });
            linePreview.style.display = 'none';
        }
    };
    
    function drawArrowOnCanvas(ctx, x1, y1, x2, y2, color, width) {
        const headLength = 15;
        const angle = Math.atan2(y2 - y1, x2 - x1);
        
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headLength * Math.cos(angle - Math.PI / 6), y2 - headLength * Math.sin(angle - Math.PI / 6));
        ctx.lineTo(x2 - headLength * Math.cos(angle + Math.PI / 6), y2 - headLength * Math.sin(angle + Math.PI / 6));
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
    }
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÁôªÈå≤
    document.addEventListener('mousedown', startDrawing);
    document.addEventListener('mousemove', processDrawing);
    document.addEventListener('mouseup', stopDrawing);
    document.addEventListener('touchstart', startDrawing, { passive: false });
    document.addEventListener('touchmove', processDrawing, { passive: false });
    document.addEventListener('touchend', stopDrawing);

    // ÂàùÊúüÈÖçÁΩÆ
    createPlayer('red');
    createPlayer('red');
    createPlayer('blue');
    createPlayer('blue');
    createPlayer('ball', false);
    
</script>
</body>
</html>